<!DOCTYPE html>
<html lang="en">

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>Zorbio Alpha</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
        <meta name="version" content="{{ VERSION }}" />
        <meta name="build" content="{{ BUILD }}" />
        <meta name="ref" content="{{ GIT_REF }}" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="theme-color" content="#171717">
        <link rel="stylesheet" href="./css/main.css"/>
    </head>

    <body>

        <div id="ui-overlay"></div>

        <canvas id="render-canvas"></canvas>

        <!-- UI TEMPLATES -->

        <script id="playing-template" type="text/ractive">
            <img id="gear-btn" on-click="{{ ACTIONS.SHOW_CONFIG }}" src="images/gear.svg">
        </script>

        <script id="config-template" type="text/ractive">
            <div id="config">
                <h1>Settings</h1>
                <div>
                    <input type="checkbox" {{ flip_y ? 'checked' : '' }} on-click="{{ ACTIONS.TOGGLE_Y_AXIS }}" id="flip-y-axis">
                    <label for="flip-y-axis">Flip Y axis</label>
                </div>
                <div>
                    <input type="checkbox" {{ flip_x ? 'checked' : '' }} on-click="{{ ACTIONS.TOGGLE_X_AXIS }}" id="flip-x-axis">
                    <label for="flip-x-axis">Flip X axis</label>
                </div>
                <div>
                    <input id="music-volume" type="range" on-change="volume-music" min="0" max="1" step="0.01" value="{{ volume.music }}">
                    <label for="music-volume">Music volume</label>
                </div>
                <div>
                    <input id="sfx-volume" type="range" on-change="volume-sfx" min="0" max="1" step="0.01" value="{{ volume.sfx }}">
                    <label for="sfx-volume">SFX volume</LABEL>
                </div>
                <button on-click="{{ ACTIONS.SHOW_PREVIOUS }}">Back</button>
            </div>
        </script>

        <script id="tutorial-template" type="text/ractive">
            <div id="tutorial">
                <div id="tutorial-content">
                    <p class="msg-1">This is you.  A sphere!</p>
                    <img src="images/tutorial/player.png" alt="image of player sphere">
                    <p class="msg-2">This is food.</p>
                    <img src="images/tutorial/player-beside-food.png" alt="image of player beside food">
                    <p class="msg-3">Eat food to grow!  To eat it, run into it.</p>
                    <p class="msg-4">This blue sphere is another player. So tiny!</p>
                    <img src="images/tutorial/player-beside-player.png" alt="image of player beside another player">
                    <p class="msg-5">Since you're bigger, you can eat the player too!</p>
                    <p class="msg-6">Your sphere will turn towards your mouse cursor.</p>
                    <p class="msg-7">Now you're ready to eat 'em up!</p>
                    <div class="player-sphere"></div>
                    <div class="player2-sphere"></div>
                    <div class="food"></div>
                </div>
                <button on-click="{{ ACTIONS.SHOW_LOGIN }}">Back</button>
            </div>
        </script>

        <script id="stats-template" type="text/ractive">
            <div id="leaders" class="{{ is_mobile ? 'mobile' : '' }}">
                <ul>
                    <li> Food captures: {{ player.foodCaptures }} </li>
                    <li> Player captures: {{ player.playerCaptures }} </li>
                    <li> Size: {{ player.score }} </li>
                </ul>
            </div>
        </script>

        <script id="leaderboard-template" type="text/ractive">
            <div id="leaderboard-playing">
                <div id="leaders" class="{{ is_mobile ? 'mobile' : '' }}">
                    <div>
                    {{ #each leaders:i }}
                        <div style="color: {{ COLORS[leaders[i].color] }}"> {{ leaders[i].name }} </div>
                    {{ /each }}
                    </div>
                    <div>
                    {{ #each leaders:i }}
                        <div style="color: {{ COLORS[leaders[i].color] }}"> {{ leaders[i].score }} </div>
                    {{ /each }}
                    </div>
                </div>
            </div>
        </script>

        <script id="social-template" type="text/ractive">
            <p id="social">
                Follow us on <a
                href="https://facebook.com/Zorbio">Facebook</a>!  Meet players,
                devs and share alpha feedback.
            </p>
        </script>

        <script id="ad-template" type="text/ractive">
            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <!-- zor-login-screen-center -->
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-3460249463041072"
                 data-ad-slot="5413768947"
                 data-ad-format="auto"></ins>
            <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </script>

        <script id="login-template" type="text/ractive">
            <div id="start-menu">
                <h1>ZORBIO</h1>
                <h2>( Alpha )</h2>
                <p>Thanks everyone for participating in our public Alpha preview!</p>
                <p>We are temporarily closing public alpha testing while we implement more features.</p>
                <p>If you would like an Alpha Key just send an email to <a href="mailto:admin@scripta.co">admin@scripta.co</a></p>
                <input on-keypress="{{ ACTIONS.PLAYER_LOGIN_KEYPRESS }}" type="text" autofocus placeholder="Player name" value="{{ player_name }}"/>
                <input on-keypress="{{ ACTIONS.PLAYER_LOGIN_KEYPRESS }}" type="text" placeholder="Alpha key" value="{{ alpha_key }}"/>
                {{ #if login_error_msg }}
                <b class="error-text">Nick name must be alphanumeric characters only!</b>
                {{ /if }}
                <button on-click="{{ ACTIONS.PLAYER_LOGIN }}" id="start-button"><span>Play</span></button>
                <button on-click="{{ ACTIONS.SHOW_TUTORIAL }}" class="secondary" id="tutorial-button"><span>Tutorial</span></button>
                <button on-click="{{ ACTIONS.SHOW_CONFIG }}" class="secondary" id="config-button"><span>Settings</span></button>
                <p>Created By <a href="https://twitter.com/caramelcode">Jared Sprague</a> and <a href="https://twitter.com/mwcz">Michael Clayton</a>.  Music by <a href="http://www.kahvi.org/releases.php?release_number=202">Acrilic Colors</a>.</p>

                {{ > social }}

                <div id="ad-login-center">
                    {{ > ad }}
                </div>

            </div>
            <p id="copy">
                &copy; 2016 <a href="http://scripta.co">Scripta, Inc.</a>  All rights reserved.  
                <a on-click="{{ ACTIONS.SHOW_CREDITS }}">Credits</a>.
            </p>
        </script>

        <script id="death-template" type="text/ractive">
            <div id="death-screen">
                <h2>YOU WERE EATEN!</h2>
                <p>by: {{ attacker.name }} {{ attacker.score }}</p>
                <button on-click="{{ ACTIONS.PLAYER_RESPAWN }}" id="respawn-button"><span>Respawn</span></button>
                <p>Nice run!  Your stats that time were:</p>
                {{ > stats }}
                {{ > social }}
            </div>
        </script>

        <script id="credits-template" type="text/ractive">
            <div id="credits">
                <p> Zorbio was created by {{ Math.random()>0.5?AUTHORS.join(' and '):AUTHORS.reverse().join(' and ') }}.  </p>
                <p> Zorbio is &copy; 2016 by <a href="http://scripta.co">Scripta, Inc.</a>  </p>
                <p> The music is <i>starfish oblivion</i> by <a href="http://www.kahvi.org/releases.php?release_number=202">Acrilic Colors</a>. </p>
                <p> Zorbio makes use of these heroic and fun open source libraries: </p>
                <ul>
                    <li> <a href="http://threejs.org/">three.js</a> &mdash; <a href="https://raw.githubusercontent.com/mrdoob/three.js/r74/LICENSE">LICENSE</a> </li>
                    <li> <a href="http://expressjs.com/">express</a> &mdash; <a href="https://raw.githubusercontent.com/expressjs/express/4.13.3/LICENSE">LICENSE</a> </li>
                    <li> <a href="http://socket.io/">socket.io</a> &mdash; <a href="https://raw.githubusercontent.com/socketio/socket.io/1.4.4/LICENSE">LICENSE</a> </li>
                    <li> <a href="https://lodash.com/">lodash</a> &mdash; <a href="https://raw.githubusercontent.com/lodash/lodash/4.0.0/LICENSE">LICENSE</a> </li>
                </ul>
                <button on-click="{{ ACTIONS.SHOW_LOGIN }}">Back</button>
            </div>
        </script>

        <script id="kicked-template" type="text/ractive">
            <div id="death-screen">
                <h2>YOU WERE REMOVED</h2>
                <p>{{ kicked_message }}</p>
                <p>You can report this on our <a href=https://github.com/ScriptaGames/zorbio-issues/issues>github page</a></p>
                <button on-click="{{ ACTIONS.PAGE_RELOAD }}" id="respawn-button"><span>Reload</span></button>
            </div>
        </script>

        <script id="initerror-template" type="text/ractive">
            <div id="game-init-error-screen">
                <h1>WebGL fell over :(</h1>
                {{ #if MISSING_FEATURES }}
                <p class="error-text">These features are required to play Zorbio, but are not supported by your browser.</p>
                <ul>
                    {{ #each MISSING_FEATURES:i }}
                    <li>{{ MISSING_FEATURES[i] }}</li>
                    {{ /each }}
                </ul>
                {{ else }}
                <p>
                    This is very sad!  We don't recognize the WebGL error that just occurred.  Visit this
                    <a href="http://get.webgl.org/troubleshooting/">WebGL
                    troubleshooting guide</a> to recover!
                </p>
                {{ /if }}
                <button on-click="{{ ACTIONS.PAGE_RELOAD }}" id="reload-button"><span>Reload</span></button>
            </div>
        </script>

        <script id="ui-template" type="text/ractive">

            {{ #if state === STATES.LOGIN_SCREEN    }} {{ > login       }} {{ /if }}
            {{ #if state === STATES.PLAYING         }} {{ > leaderboard }} {{ /if }}
            {{ #if state === STATES.PLAYING         }} {{ > playing     }} {{ /if }}
            {{ #if state === STATES.CONFIG          }} {{ > config      }} {{ /if }}
            {{ #if state === STATES.TUTORIAL_SCREEN }} {{ > tutorial    }} {{ /if }}
            {{ #if state === STATES.RESPAWN_SCREEN  }} {{ > death       }} {{ /if }}
            {{ #if state === STATES.KICKED_SCREEN   }} {{ > kicked      }} {{ /if }}
            {{ #if state === STATES.GAME_INIT_ERROR }} {{ > initerror   }} {{ /if }}
            {{ #if state === STATES.CREDITS_SCREEN  }} {{ > credits     }} {{ /if }}

            {{ #if server_message }}
            <div id="server-message"> {{ server_message }} </div>
            {{ /if }}

        </script>

        <script id="drain-vertex-shader" type="x-shader/x-vertex">
            varying vec2 vUv;
            #ifdef USE_MORPHTARGETS
                #ifndef USE_MORPHNORMALS
                    uniform float morphTargetInfluences[ 8 ];
                #else
                    uniform float morphTargetInfluences[ 4 ];
                #endif
            #endif
            void main()
            {
                vUv = uv;

                vec3 transformed = vec3( position );

                #ifdef USE_MORPHTARGETS
                transformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];
                transformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];
                transformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];
                transformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];
                #ifndef USE_MORPHNORMALS
                transformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];
                transformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];
                transformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];
                transformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];
                #endif
                #endif

                vec4 mvPosition = modelViewMatrix * vec4(transformed, 1.0 );
                gl_Position = projectionMatrix * mvPosition;
            }
        </script>

        <script id="drain-frag-shader" type="x-shader/x-fragment">
            #define MAX_OPACITY 0.30

            uniform float time;
            uniform float power;
            uniform float len;
            uniform vec3 erColor;
            uniform vec3 eeColor;
            varying vec2 vUv;

            float fade(float x) {
                // fade out near the ends of the cylinder according to equation:
                // https://www.desmos.com/calculator/uergngo1w6
                float hh = 0.5;
                float n = x - 0.5;
                return 1.0 - n*n/hh/hh;
            }

            void main(void) {

                vec3 color = vec3((sin(10.0 * vUv.y - time*8.0) + 0.5) / 2.0);

                color *= mix(erColor, eeColor, 1.0 - vUv.y);

                float alpha = MAX_OPACITY * power * fade(vUv.y);

                gl_FragColor = vec4(vec3(color), alpha);
            }
        </script>

        <script id="food-geo-frag-shader" type="x-shader/x-fragment">
            precision highp float;

            uniform sampler2D map;

            uniform float FOG_ENABLED;
            uniform float FOG_FAR;
            uniform float ALPHA_ENABLED;
            uniform float FOOD_RESPAWN_ANIM_DURATION;

            varying vec2 vUv;
            varying vec3 vColor;
            varying float vRespawning;
            varying float sDist;
            varying float vGrowing;

            void main() {

                float fogp = 1.0;
                float alpha = 1.0;
                vec4 diffuseColor = texture2D( map, vUv );

                if ( diffuseColor.w < 0.5 ) discard;
                if ( vRespawning > FOOD_RESPAWN_ANIM_DURATION ) discard;

                if ( FOG_ENABLED != 0.0 ) {
                    fogp = 1.0 - sDist / FOG_FAR;
                    // also, drop any foods beyond frustum
                    if ( sDist > FOG_FAR ) discard;
                }

                if ( ALPHA_ENABLED != 0.0 ) {
                    alpha = fogp - 0.3;
                    alpha *= vGrowing;
                }

                alpha *= diffuseColor.w;

                gl_FragColor = vec4( fogp * diffuseColor.xyz * vColor, alpha );

            }
        </script>

        <script type="x-shader/x-vertex" id="food-geo-vertex-shader">
            precision highp float;
            uniform mat4 modelViewMatrix;
            uniform mat4 projectionMatrix;
            uniform vec3 mainSpherePos;
            uniform float FOOD_RESPAWN_ANIM_DURATION;

            attribute vec3 translate;
            attribute vec2 uv;
            attribute vec3 normal;
            attribute vec3 position;
            attribute vec3 color;
            attribute float respawning;

            varying vec2 vUv;
            varying vec3 vColor;

            varying float vRespawning;
            varying float sDist;
            varying float vDist;
            varying float vGrowing;

            void main() {

                vec4 mvPosition = modelViewMatrix * vec4( translate, 1.0 );

                float growing = 1.0 - respawning / FOOD_RESPAWN_ANIM_DURATION;

                mvPosition.xyz += position * growing;

                vRespawning = respawning;
                vUv         = uv;
                vColor      = color;
                vDist       = length( mvPosition.xyz ); // distance from camera
                sDist       = length( translate - mainSpherePos ); // distance from sphere to particle
                vGrowing    = growing;

                gl_Position = projectionMatrix * mvPosition;

            }
        </script>

        <!-- FOOD SHADERS -->

        <script type="x-shader/x-vertex" id="food-vertex-shader">

            uniform float size;
            uniform vec3 mainSpherePos;
            uniform float FOOD_RESPAWN_ANIM_DURATION;

            attribute vec3 ca;
            attribute float respawning;

            varying vec3 vColor;
            varying float vRespawning;
            varying float sDist;
            varying float vDist;
            varying float vGrowing;

            void main() {

                vRespawning = respawning;
                vColor      = ca;

                vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

                vDist = length( mvPosition.xyz ); // distance from camera

                sDist = length( position - mainSpherePos ); // distance from sphere to particle

                float growing = 1.0 - respawning / FOOD_RESPAWN_ANIM_DURATION;
                vGrowing = growing;

                // point size is relative to distance from camera
                gl_PointSize =  growing * ( size / vDist );

                gl_Position = projectionMatrix * mvPosition;

            }

        </script>

        <script type="x-shader/x-fragment" id="food-fragment-shader">

            uniform vec3 color;
            uniform sampler2D texture;
            uniform float FOG_ENABLED;
            uniform float FOG_FAR;
            uniform float ALPHA_ENABLED;
            uniform float FOOD_RESPAWN_ANIM_DURATION;

            varying vec3 vColor;
            varying float vRespawning;
            varying float sDist;
            varying float vGrowing;

            void main() {

                float fogp = 1.0;
                float alpha = 1.0;

                // when food's respawning value is > 0.0, it's still counting
                // down to respawn
                if ( vRespawning > FOOD_RESPAWN_ANIM_DURATION ) discard;

                if ( FOG_ENABLED != 0.0 ) {
                    // if fog is enabled, fade out
                    fogp = 1.0 - sDist / FOG_FAR;
                }

                if ( ALPHA_ENABLED != 0.0 ) {
                    alpha = fogp - 0.3;
                    alpha *= vGrowing;
                }

                gl_FragColor = vec4( fogp * vColor, alpha );

                if ( ALPHA_ENABLED != 0.0 ) {
                    gl_FragColor *= texture2D( texture, gl_PointCoord );
                }

            }

        </script>

        <!-- SPHERE SHADERS -->

        <script type="x-shader/x-vertex" id="sphere-vertex-shader">
            uniform vec3 color;
            uniform vec3 mainSpherePos;
            uniform vec3 spherePos;

            uniform float c;
            uniform float p;

            uniform float FOG_ENABLED;
            uniform float FOG_FAR;

            varying float vIntensity;
            varying float sDist;
            varying vec3 vNormal;
            varying vec3 vNormel;
            varying float vDot;

            void main() {
                vec3 viewVector = cameraPosition - spherePos;
                vec3 vNormal = normalize( normalMatrix * normal );
                vec3 vNormel = normalize( normalMatrix * viewVector );
                vDot = dot(vNormal, vNormel);
                vIntensity = pow( c - vDot, p );

                vec4 mMainSpherePos = modelViewMatrix * vec4( mainSpherePos, 1.0 );
                vec4 mSpherePos = modelViewMatrix * vec4( spherePos, 1.0 );

                sDist = length( mainSpherePos - spherePos ); // distance from main sphere to this sphere

                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            }
        </script>

        <script type="x-shader/x-fragment" id="sphere-fragment-shader">
            #define PI 3.141592653589
            #define TWOPI 6.283185307178
            uniform vec3 color;
            uniform vec3 colorHSL;
            uniform float FOG_ENABLED;
            uniform float FOG_FAR;

            varying float vIntensity;
            varying float sDist;
            varying vec3 vNormal;
            varying vec3 vNormel;
            varying float vDot;

            vec3 rgb2hsv(vec3 c) {
                vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
                vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
                vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));

                float d = q.x - min(q.w, q.y);
                float e = 1.0e-10;
                return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
            }

            vec3 hsv2rgb(vec3 c) {
                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
            }

            void main() {

                float fogp = 1.0;
                vec3 mColor = rgb2hsv(color);
                mColor.x += vDot / TWOPI;
                    /* hsl2rgb( vIntensity / (PI/2.0), 1.0, 0.7) * color; */

                mColor = hsv2rgb(mColor);

                if ( FOG_ENABLED != 0.0 ) {
                    fogp = 1.0 - sDist / FOG_FAR;
                }

                float strength = vIntensity * fogp; // min( fogp, vIntensity );

                gl_FragColor = vec4( mColor, strength );
            }
        </script>

        <!-- third party -->
        <script src="./lib/modernizr.min.js"></script>
        <script src="./bower_components/ractive/ractive.js"></script>
        <script src="./bower_components/three.js/three.js"></script>
        <script src="./lib/Octree.js"></script>
        <script src="./bower_components/isMobile/isMobile.min.js"></script>
        <script src="./bower_components/lodash/dist/lodash.min.js"></script>
        <script src="./bower_components/uri.js/src/URI.min.js"></script>
        <script src="./bower_components/howler.js/howler.js"></script>

        <!-- first party -->
        <script src="./lib/environment.js"></script>
        <script src="./js/config.js"></script>
        <script src="./js/FollowOrbitControls.js"></script>
        <script src="./js/TrackballControls.js"></script>
        <script src="./lib/util.js"></script>
        <script src="./lib/zorbio.js"></script>
        <script src="./js/LagScale.js"></script>
        <script src="./js/Sounds.js"></script>
        <script src="./js/PlayerView.js"></script>
        <script src="./js/UI.js"></script>
        <script src="./js/Game.js"></script>
        <script src="./js/PlayerController.js"></script>
        <script src="./js/FoodController.js"></script>
        <script src="./js/FoodView.js"></script>
        <script src="./js/Main.js"></script>
        <script src="./js/Network.js"></script>
        <script src="./js/DrainView.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-73203609-1', 'auto');
            ga('send', 'pageview');

        </script>
    </body>
</html>
