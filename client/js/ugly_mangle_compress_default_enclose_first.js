(function jaredisgreat(){var e=e||{};e.PlayerSkins=e.PlayerSkins||{};e.PlayerSkins.earth=function e(t){var i=t.is_current_player?.2:.6;return{geometry:{},material:{uniforms:{c:{type:"f",value:1.41803},p:{type:"f",value:2.71828},spherePos:{type:"v3",value:t.model.sphere.position},mainSpherePos:{type:"v3",value:R},FOG_FAR:{type:"f",value:r.FOG_FAR},FOG_ENABLED:{type:"f",value:~~r.FOG_ENABLED},sphereTexture:{type:"t",value:(new THREE.TextureLoader).load("skins/earth/earth-sphere-map.jpg")}},vertexShader:document.getElementById("skin-earth-vertex-shader").textContent,fragmentShader:document.getElementById("skin-earth-fragment-shader").textContent,transparent:true},behavior:{},trail:{type:"particle",group:{scale:Math.max(window.innerWidth,window.innerHeight),texture:{value:(new THREE.TextureLoader).load("skins/earth/trail.png")},maxParticleCount:800},emitter:{maxAge:{value:8},position:{value:new THREE.Vector3(0,0,0),spread:new THREE.Vector3(0,0,0),spreadClamp:new THREE.Vector3(0,0,0),radius:5,distribution:SPE.distributions.SPHERE},opacity:{value:[i,0]},angle:{value:[0],spread:[8,0]},drag:{value:8},color:{value:new THREE.Color("#B9D5EB")},size:{value:[6,0]},particleCount:800,activeMultiplier:.1}},capture:{customScale:1,group:{scale:Math.max(window.innerWidth,window.innerHeight),maxParticleCount:1e3,texture:{value:(new THREE.TextureLoader).load("textures/smokeparticle.png")},blending:THREE.AdditiveBlending},emitter:{type:SPE.distributions.SPHERE,position:{spread:new THREE.Vector3(5),radius:10},velocity:{spread:new THREE.Vector3(100)},size:{value:[30,0]},opacity:{value:[1,0]},color:{value:[new THREE.Color("yellow"),new THREE.Color("red")]},particleCount:100,alive:false,duration:.05,maxAge:{value:1}}}}};e.PlayerSkins.earth.meta={friendly_name:"Planet Earth",name:"earth",preview:"skins/earth/thumb.jpg",sort:2};var e=e||{};e.PlayerSkins=e.PlayerSkins||{};e.PlayerSkins.default=function e(t){var i=t.is_current_player?.4:.8;var n=new THREE.Color(t.playerColor);return{geometry:{},material:{uniforms:{c:{type:"f",value:1.41803},p:{type:"f",value:2.71828},color:{type:"c",value:n},colorHSL:{type:"v3",value:n.getHSL()},spherePos:{type:"v3",value:t.model.sphere.position},mainSpherePos:{type:"v3",value:R},FOG_FAR:{type:"f",value:r.FOG_FAR},FOG_ENABLED:{type:"f",value:~~r.FOG_ENABLED}},vertexShader:document.getElementById("skin-default-vertex-shader").textContent,fragmentShader:document.getElementById("skin-default-fragment-shader").textContent,transparent:true},behavior:{faceCamera:false},trail:{type:"line",customScale:1,lineWidth:function e(t){return t},origins:[new THREE.Vector3(.9,0,0),new THREE.Vector3(-.9,0,0)],color:n},capture:{customScale:1,group:{scale:Math.max(window.innerWidth,window.innerHeight),maxParticleCount:1e3,texture:{value:(new THREE.TextureLoader).load("skins/default/trail.png")},blending:THREE.AdditiveBlending},emitter:{type:SPE.distributions.SPHERE,position:{spread:new THREE.Vector3(5),radius:10},velocity:{spread:new THREE.Vector3(100)},size:{value:[60,0]},opacity:{value:[1,0]},color:{value:[n]},particleCount:70,alive:false,duration:.05,maxAge:{value:1}}}}};e.PlayerSkins.default.meta={friendly_name:"Smooth Shade",name:"default",preview:"skins/default/thumb.jpg",sort:1};var e=e||{};e.PlayerSkins=e.PlayerSkins||{};e.PlayerSkins.boing=function e(t){var i=new THREE.Color("#D71C26");return{geometry:{polycount_w:20,polycount_h:10},material:{uniforms:{c:{type:"f",value:1.41803},p:{type:"f",value:2.71828},spherePos:{type:"v3",value:t.model.sphere.position},mainSpherePos:{type:"v3",value:R},FOG_FAR:{type:"f",value:r.FOG_FAR},FOG_ENABLED:{type:"f",value:~~r.FOG_ENABLED},sphereTexture:{type:"t",value:(new THREE.TextureLoader).load("skins/boing/texture.jpg")}},vertexShader:document.getElementById("skin-boing-vertex-shader").textContent,fragmentShader:document.getElementById("skin-boing-fragment-shader").textContent,transparent:true},behavior:{},trail:{type:"line",customScale:1,lineWidth:function e(t){return t},origins:[new THREE.Vector3(.9,0,0),new THREE.Vector3(-.9,0,0)],color:i},capture:{customScale:1,group:{scale:Math.max(window.innerWidth,window.innerHeight),maxParticleCount:1e3,texture:{value:(new THREE.TextureLoader).load("skins/boing/trail.png")},blending:THREE.AdditiveBlending},emitter:{type:SPE.distributions.SPHERE,position:{spread:new THREE.Vector3(5),radius:10},velocity:{spread:new THREE.Vector3(100)},size:{value:[100,0]},opacity:{value:[1,0]},color:{value:[i]},particleCount:50,alive:false,duration:.05,maxAge:{value:1}}}}};e.PlayerSkins.boing.meta={friendly_name:"Boing",name:"boing",preview:"skins/boing/thumb.jpg",sort:3};var e=e||{};e.PlayerSkins=e.PlayerSkins||{};e.PlayerSkins.reddit=function e(t){var i=t.is_current_player?.2:.6;return{geometry:{spin:{y:.001}},material:{uniforms:{c:{type:"f",value:1.41803},p:{type:"f",value:2.71828},spherePos:{type:"v3",value:t.model.sphere.position},mainSpherePos:{type:"v3",value:R},FOG_FAR:{type:"f",value:r.FOG_FAR},FOG_ENABLED:{type:"f",value:~~r.FOG_ENABLED},sphereTexture:{type:"t",value:(new THREE.TextureLoader).load("skins/reddit/texture.jpg")}},vertexShader:document.getElementById("skin-reddit-vertex-shader").textContent,fragmentShader:document.getElementById("skin-reddit-fragment-shader").textContent,transparent:true},behavior:{},trail:{type:"line",customScale:1.5,lineWidth:function e(t){return t},origins:[new THREE.Vector3(.9,0,0),new THREE.Vector3(-.9,0,0)],color:new THREE.Color("#FF431D")},capture:{customScale:1,group:{scale:Math.max(window.innerWidth,window.innerHeight),maxParticleCount:1e3,texture:{value:(new THREE.TextureLoader).load("textures/smokeparticle.png")},blending:THREE.AdditiveBlending},emitter:{type:SPE.distributions.SPHERE,position:{spread:new THREE.Vector3(5),radius:10},velocity:{spread:new THREE.Vector3(100)},size:{value:[30,0]},opacity:{value:[1,0]},color:{value:[new THREE.Color("yellow"),new THREE.Color("red")]},particleCount:100,alive:true,duration:.05,maxAge:{value:1}}}}};e.PlayerSkins.reddit.meta={friendly_name:"Reddit",name:"reddit",preview:"skins/reddit/thumb.png",unlock_url:"?reddit",sort:0};var t=typeof module!=="undefined"&&module.exports;var e=e||{};e.Env={WORLD_SIZE:1e3,MAX_BOTS:10,FOOD_DENSITY:9,INITIAL_PLAYER_RADIUS:5,FOOD_VALUE:5,DEBUG:true,HEARTBEAT_ENABLE:false,BALANCER:"LOCAL",CHECK_ORIGIN:false,CHECK_VERSION:false,REQUIRE_ALPHA_KEY:false,AUTO_RUN_ENABLED:true,NUM_GAME_INSTANCES:1,ENABLE_HTTP_SERVER:true,ENABLE_BACKEND_SERVICE:false};if(t)module.exports=e.Env;var t=typeof module!=="undefined"&&module.exports;if(t){global.self={};global.THREE=require("three");var i=require("lodash");var e={Env:require("../common/environment.js")}}var r={};r.DEBUG=false;r.AUTO_PLAY=false;r.REQUIRE_ALPHA_KEY=true;r.WORLD_SIZE=2e3;r.WORLD_HYPOTENUSE=Math.sqrt(Math.pow(Math.sqrt(Math.pow(r.WORLD_SIZE,2)+Math.pow(r.WORLD_SIZE,2)),2)+Math.pow(r.WORLD_SIZE,2));r.MAX_BOTS=25;r.MAX_BOT_RADIUS=100;r.ENABLE_HTTP_SERVER=false;r.HTTP_PORT=8080;r.WS_PORT=31e3;r.NUM_GAME_INSTANCES=4;r.MAX_PLAYERS_PER_INSTANCE=25;r.HEARTBEAT_ENABLE=true;r.HEARTBEAT_TIMEOUT=3e4;r.HEARTBEAT_CHECK_INTERVAL=1e3;r.HEARTBEAT_PULSE_INTERVAL=5e3;r.TICK_SLOW_INTERVAL=200;r.TICK_FAST_INTERVAL=50;r.PENDING_PLAYER_CAPTURE_TTL=3e3;r.CHECK_VERSION=true;r.CHECK_VERSION_INTERVAL=3e4;r.LEADERS_LENGTH=10;r.BIN_PP_POSITIONS_LENGTH=29;r.CHECK_ORIGIN=true;r.RECENT_CLIENT_DATA_LENGTH=100;r.CLOSE_NO_RESTART=4e3;r.STATUS_LOG_DELAY=15e3;r.ENABLE_RAPID_UPDATES=true;r.ENABLE_BACKEND_SERVICE=true;if(!t){r.GET_NEAR_BALANCER=function e(){var t=localStorage.getItem("balancer");if(t){return t}var i=linodeNearLocation();console.log("Nearest linode location: ",i);switch(i){case"london":case"frankfurt":case"singapore":case"fremont":case"dallas":case"newark":t="newark";break;default:t="newark"}return t};r.BALANCER=r.GET_NEAR_BALANCER()}r.BALANCERS=Object.freeze({LOCAL:"localhost",fremont:"uswest.zor.bio",dallas:"uscentral.zor.bio",newark:"useast.zor.bio",london:"uk.zor.bio",frankfurt:"eu.zor.bio",singapore:"apac.zor.bio",prod:"zor.bio",prodwww:"www.zor.bio"});r.INITIAL_PLAYER_RADIUS=5;r.MAX_PLAYER_RADIUS=150;r.MAX_PLAYER_SPEED=2;r.STATIONARY_RADIUS=r.MAX_PLAYER_RADIUS+25;r.PLAYER_CAPTURE_VALUE=function e(t){return t/2};r.PLAYER_GET_SPEED=function e(t){var i=r.MAX_PLAYER_SPEED;return i-t*i/r.STATIONARY_RADIUS};r.PLAYER_GET_SCORE=function e(t){return Math.floor(t*10)};r.AUTO_RUN_ENABLED=true;r.STEERING_METHODS=Object.freeze({MOUSE_DRAG:{NAME:"DRAG",SPEED:.2},MOUSE_FOLLOW:{NAME:"FOLLOW",WELL:.01,SLOPE:10,SPEED:.3}});r.STEERING=r.STEERING_METHODS.MOUSE_FOLLOW;r.Y_AXIS_MULT=1;r.X_AXIS_MULT=1;r.HIDE_OWN_TRAIL=false;r.ABILITY_SPEED_BOOST_DURATION=500;r.ABILITY_SPEED_BOOST_MIN_SCALE=r.INITIAL_PLAYER_RADIUS;r.ABILITY_SPEED_BOOST_MULTIPLIER=1.75;r.ABILITY_SPEED_BOOST_PENALTY=.05;r.DRAIN_MAX_DISTANCE=300;r.DRAIN_PINCH_STRENGTH=.4;r.DRAIN_RADIO_FREQUENCY=65;r.FOOD_DENSITY=33;r.FOOD_VALUE=.5;r.FOOD_RESPAWN_TIME=3e4;r.FOOD_RESPAWN_ANIM_DURATION=60;r.FOOD_CAPTURE_ASSIST=1;r.FOOD_MAP_TYPE="random";r.FOOD_COLORING_TYPE="hsl01";r.FOOD_COLORING_SINE_SEGMENTS=8;r.FOOD_GET_VALUE=function e(t){return r.FOOD_VALUE/(t-4)};r.ENABLE_VALIDATION=true;r.FOOD_CAPTURE_EXTRA_TOLERANCE=10;r.PLAYER_CAPTURE_EXTRA_TOLERANCE=1;r.SPEED_EXTRA_TOLERANCE=.08;r.PLAYER_SCALE_EXTRA_TOLERANCE=.1;r.PLAYER_POSITIONS_WINDOW=30;r.INFRACTION_TOLERANCE_FOOD=20;r.INFRACTION_TOLERANCE_PCAP=1;r.INFRACTION_TOLERANCE_SPEED=7;r.INFRACTION_TOLERANCE_SCALE=1;r.MOVE_VALIDATION_SAMPLE_RATE=5;r.LOADING_WAIT_DURATION=1e4;r.MAX_PLAYER_NAME_LENGTH=15;r.FOG_ENABLED=true;r.FOG_NEAR=100;r.FOG_FAR=1e3;r.FOG_COLOR=THREE.ColorKeywords.black;r.INITIAL_CAMERA_DISTANCE=50;r.WALL_GRID_SEGMENTS=20;r.INITIAL_FOV=50;r.PLAYER_MOVE_LERP_WEIGHT=.3;r.PLAYER_SPHERE_POLYCOUNT=64;r.FOOD_ALPHA_ENABLED=false;r.LAG_SCALE_ENABLE=true;r.REQUIRED_WEBGL_EXTENSIONS=["ANGLE_instanced_arrays"];r.TRAIL_LINE_LENGTH=40;r.TRAIL_LINE_WIDTH=.3;r.CAPTURE_PARTICLE_ATTRACTION_SPEED=.994;r.TITLE_CAMERA_SPIN_SPEED=.001;r.CAMERA_ZOOM_STEP_SIZE=.0175;r.CAMERA_ZOOM_DISTANCE_INITIAL=100;r.CAMERA_ZOOM_DISTANCE_FINAL=500;r.CAMERA_ZOOM_STEP_BUFFER=.5;r.CAMERA_ZOOM_STEP_S=(r.CAMERA_ZOOM_DISTANCE_FINAL-r.CAMERA_ZOOM_DISTANCE_INITIAL)/(r.MAX_PLAYER_RADIUS-r.INITIAL_PLAYER_RADIUS);r.GET_CAMERA_MIN_DISTANCE=function e(t){return Math.floor(t*r.CAMERA_ZOOM_STEP_S*r.CAMERA_ZOOM_STEP_SIZE)/r.CAMERA_ZOOM_STEP_SIZE+r.CAMERA_ZOOM_DISTANCE_INITIAL};r.CAMERA_ZOOM_STEPS={};function n(){var e=r.INITIAL_PLAYER_RADIUS;var t=0;var i=r.GET_CAMERA_MIN_DISTANCE(e);var n=0;while(e<=r.MAX_PLAYER_RADIUS*2){n=r.GET_CAMERA_MIN_DISTANCE(e);if(n>i){var o=Math.floor(i);r.CAMERA_ZOOM_STEPS[o]={min:t,max:e};t=e;i=n}e+=.1}}n();r.COLORS=["#e5353a","#e53570","#e535c4","#7135e5","#353de5","#3588e5","#35dde5","#35e5a3","#35e569","#36e535","#96e535","#e5bf35","#e57035","#e53f35","#e40000","#38FF4D","#38FFC3","#417AFF","#41ACFF","#5941FF","#99FF38","#A040FF","#E140FF","#F8FF38","#FF386A","#FF6B38","#FF6DD2","#FFB638","#FFF42E"];r.SKINS={default:"default",earth:"earth",boing:"boing",reddit:"reddit"};if(!t){r.VOLUME_MUSIC_INITIAL=localStorage.volume_music||.45;r.VOLUME_SFX_INITIAL=localStorage.volume_sfx||1}r.MUSIC_ENABLED=false;r.SFX_FOOD_CAPTURE_TONES=["D3","E3","G3","G4","A3","A4","D4","B3","B4","C3","E4","Gb3"];r.VOLUME_FOOD_CAPTURE=.05;r.VOLUME_FALLOFF_RATE=2;r.BROWSER_FORCE_DISABLED_FEATURES=[];i.assign(r,e.Env);if(t){module.exports=r}else{r.BALANCER=r.BALANCERS[r.BALANCER];if(!r.DEBUG){console.log=function(){}}}if(!r.DEBUG){Raven.config("https://5b9c66b633364e43bc97ec763be5d018@app.getsentry.com/94111").install()}(function(){function e(e){var t=new THREE.Matrix4;var i=e.projectionMatrix.makeFrustum.bind(e.projectionMatrix);e.projectionMatrix.makeFrustum=function(e,r,n,o,a,s){return i(e,r,n,o,a,s).multiply(t)};e.setRoll=function(e){t.makeRotationZ(e);this.updateProjectionMatrix()}}function t(t){this.object=t;e(this.object);this.target=new THREE.Object3D;this.minDistance=0;this.maxDistance=Infinity;this.minPolarAngle=-Infinity;this.maxPolarAngle=Infinity;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.enableDamping=false;this.dampingFactor=.25;this.velocityRequest=new THREE.Vector3;this.foobar=0;var i=this;var n=1e-6;var o;var a;var s=0;var l=0;var c=1;var u=false;this.getPolarAngle=function(){return a};this.getAzimuthalAngle=function(){return o};this.rotateLeft=function(e){l-=e*r.X_AXIS_MULT};this.rotateUp=function(e){s-=e*r.Y_AXIS_MULT};this.panLeft=function(){var e=new THREE.Vector3;return function t(r){var n=this.object.matrix.elements;e.set(n[0],n[1],n[2]);e.multiplyScalar(-r);i.velocityRequest.add(e)}}();this.panUp=function(){var e=new THREE.Vector3;return function t(r){var n=this.object.matrix.elements;e.set(n[4],n[5],n[6]);e.multiplyScalar(r);i.velocityRequest.add(e)}}();this.pan=function(e,t,r,n){var o=i.object.position;var a=o.clone().sub(i.target.position);var s=a.length();var l=i.upside_down?1:-1;s*=Math.tan(i.object.fov/2*Math.PI/180);i.panLeft(2*l*e*s/n);i.panUp(2*l*t*s/n)};this.dollyIn=function(e){c/=e};this.dollyOut=function(e){c*=e};this.update=function(){var e=new THREE.Vector3;var r=(new THREE.Quaternion).setFromUnitVectors(t.up,new THREE.Vector3(0,1,0));var p=r.clone().inverse();var h=new THREE.Vector3;var d=new THREE.Quaternion;i.upside_down=false;return function(){var t=this.object.position;e.copy(t).sub(this.target.position);e.applyQuaternion(r);o=Math.atan2(e.x,e.z);a=Math.atan2(Math.sqrt(Math.pow(e.x,2)+Math.pow(e.z,2)),e.y);if(i.upside_down){if(a-s>Math.PI||a-s<0){o+=Math.PI;a%=Math.PI;i.upside_down=false;this.object.setRoll(0)}}else{if(a+s>Math.PI||a+s<0){o+=Math.PI;a%=Math.PI;i.upside_down=true;this.object.setRoll(Math.PI)}}if(i.upside_down){o-=l;a-=s}else{o+=l;a+=s}var f=e.length()*c;f=Math.max(this.minDistance,Math.min(this.maxDistance,f));e.x=f*Math.sin(a)*Math.sin(o);e.y=f*Math.cos(a);e.z=f*Math.sin(a)*Math.cos(o);e.applyQuaternion(p);t.copy(this.target.position).add(e);this.object.lookAt(this.target.position);if(this.enableDamping===true){l*=1-this.dampingFactor;s*=1-this.dampingFactor}else{l=0;s=0}c=1;if(u||h.distanceToSquared(this.object.position)>n||8*(1-d.dot(this.object.quaternion))>n){h.copy(this.object.position);d.copy(this.object.quaternion);u=false;return true}return false}}()}THREE.FollowOrbitControls=function(e,i){var n=new t(e);this.domElement=i!==undefined?i:document;Object.defineProperty(this,"constraint",{get:function(){return n}});this.getPolarAngle=function(){return n.getPolarAngle()};this.getAzimuthalAngle=function(){return n.getAzimuthalAngle()};this.enabled=true;this.center=this.target.position;this.enableZoom=true;this.zoomSpeed=1;this.enableRotate=true;this.rotateSpeed=r.STEERING.SPEED;this.enablePan=true;this.keyPanSpeed=7;this.autoRotate=false;this.autoRotateSpeed=2;this.enableKeys=true;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var o=this;var a=new THREE.Vector2;var s=new THREE.Vector2;var l=new THREE.Vector2;var c=new THREE.Vector2;var u=new THREE.Vector2;var p=new THREE.Vector2;var h=new THREE.Vector2;var d=new THREE.Vector2;var f=new THREE.Vector2;var m={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5};var _=0;var E=0;var v=m.NONE;this.target0=this.target.position.clone();this.position0=this.object.position.clone();this.zoom0=this.object.zoom;var y={type:"change"};var g={type:"start"};var A={type:"end"};var S=new THREE.Vector2;var w=o.domElement===document?o.domElement.body:o.domElement;function I(e,t){var i=o.domElement===document?o.domElement.body:o.domElement;n.pan(e,t,i.clientWidth,i.clientHeight)}this.update=function(){if(this.autoRotate&&v===m.NONE){n.rotateLeft(R())}if(r.STEERING.NAME==="FOLLOW"){if(o.enableRotate===false)return;S.setX(w.clientWidth/2-_);S.setY(w.clientHeight/2-E);var e=S.length();S.normalize().multiplyScalar(P(e));s.copy(S);l.subVectors(s,a);n.rotateLeft(S.x);n.rotateUp(S.y);a.copy(s)}if(n.update()===true){this.dispatchEvent(y)}};this.reset=function(){v=m.NONE;this.target.position.copy(this.target0);this.object.position.copy(this.position0);this.object.zoom=this.zoom0;this.object.updateProjectionMatrix();this.dispatchEvent(y);this.update()};function R(){return 2*Math.PI/60/60*o.autoRotateSpeed}function T(){return Math.pow(.95,o.zoomSpeed)}function O(e){if(o.enabled===false)return;if(r.STEERING.NAME!=="DRAG")return;e.preventDefault();if(e.button===o.mouseButtons.ORBIT){if(o.enableRotate===false)return;v=m.ROTATE;a.set(e.clientX,e.clientY)}else if(e.button===o.mouseButtons.PAN){if(o.enablePan===false)return;v=m.PAN;c.set(e.clientX,e.clientY)}if(v!==m.NONE){document.addEventListener("mousemove",L,false);document.addEventListener("mouseup",N,false);o.dispatchEvent(g)}}function P(e){return Math.min(0,-1*r.STEERING.SLOPE*(e-r.STEERING.WELL))}function L(e){_=e.clientX;E=e.clientY;if(o.enabled===false)return;if(r.STEERING.NAME!=="DRAG")return;e.preventDefault();var t=o.domElement===document?o.domElement.body:o.domElement;if(v===m.ROTATE){if(o.enableRotate===false)return;s.set(e.clientX,e.clientY);l.subVectors(s,a);n.rotateLeft(2*Math.PI*l.x/t.clientWidth*o.rotateSpeed);n.rotateUp(2*Math.PI*l.y/t.clientHeight*o.rotateSpeed);a.copy(s)}else if(v===m.DOLLY){if(o.enableZoom===false)return;d.set(e.clientX,e.clientY);f.subVectors(d,h);if(f.y>0){n.dollyIn(T())}else if(f.y<0){n.dollyOut(T())}h.copy(d)}else if(v===m.PAN){if(o.enablePan===false)return;u.set(e.clientX,e.clientY);p.subVectors(u,c);I(p.x,p.y);c.copy(u)}if(v!==m.NONE)o.update()}function N(){if(o.enabled===false)return;document.removeEventListener("mousemove",L,false);document.removeEventListener("mouseup",N,false);o.dispatchEvent(A);v=m.NONE}function b(e){if(o.enabled===false||o.enableZoom===false||v!==m.NONE)return;e.preventDefault();e.stopPropagation();var t=0;if(e.wheelDelta!==undefined){t=e.wheelDelta}else if(e.detail!==undefined){t=-e.detail}if(t>0){n.dollyOut(T())}else if(t<0){n.dollyIn(T())}o.update();o.dispatchEvent(g);o.dispatchEvent(A)}function C(e){if(o.enabled===false||o.enableKeys===false||o.enablePan===false)return;switch(e.keyCode){case o.keys.UP:I(0,o.keyPanSpeed);o.update();break;case o.keys.BOTTOM:I(0,-o.keyPanSpeed);o.update();break;case o.keys.LEFT:I(o.keyPanSpeed,0);o.update();break;case o.keys.RIGHT:I(-o.keyPanSpeed,0);o.update();break}}function D(e){if(o.enabled===false)return;switch(e.touches.length){case 1:if(o.enableRotate===false)return;v=m.TOUCH_ROTATE;a.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(o.enableZoom===false)return;v=m.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX;var i=e.touches[0].pageY-e.touches[1].pageY;var r=Math.sqrt(t*t+i*i);h.set(0,r);break;case 3:if(o.enablePan===false)return;v=m.TOUCH_PAN;c.set(e.touches[0].pageX,e.touches[0].pageY);break;default:v=m.NONE}if(v!==m.NONE)o.dispatchEvent(g)}function M(e){if(o.enabled===false)return;e.preventDefault();e.stopPropagation();var t=o.domElement===document?o.domElement.body:o.domElement;switch(e.touches.length){case 1:if(o.enableRotate===false)return;if(v!==m.TOUCH_ROTATE)return;s.set(e.touches[0].pageX,e.touches[0].pageY);l.subVectors(s,a);n.rotateLeft(2*Math.PI*l.x/t.clientWidth*o.rotateSpeed);n.rotateUp(2*Math.PI*l.y/t.clientHeight*o.rotateSpeed);a.copy(s);o.update();break;case 2:if(o.enableZoom===false)return;if(v!==m.TOUCH_DOLLY)return;var i=e.touches[0].pageX-e.touches[1].pageX;var r=e.touches[0].pageY-e.touches[1].pageY;var _=Math.sqrt(i*i+r*r);d.set(0,_);f.subVectors(d,h);if(f.y>0){n.dollyOut(T())}else if(f.y<0){n.dollyIn(T())}h.copy(d);o.update();break;case 3:if(o.enablePan===false)return;if(v!==m.TOUCH_PAN)return;u.set(e.touches[0].pageX,e.touches[0].pageY);p.subVectors(u,c);I(p.x,p.y);c.copy(u);o.update();break;default:v=m.NONE}}function F(){if(o.enabled===false)return;o.dispatchEvent(A);v=m.NONE}function U(e){e.preventDefault()}this.dispose=function(){this.domElement.removeEventListener("contextmenu",U,false);this.domElement.removeEventListener("mousedown",O,false);this.domElement.removeEventListener("mousewheel",b,false);this.domElement.removeEventListener("MozMousePixelScroll",b,false);this.domElement.removeEventListener("touchstart",D,false);this.domElement.removeEventListener("touchend",F,false);this.domElement.removeEventListener("touchmove",M,false);document.removeEventListener("mousemove",L,false);document.removeEventListener("mouseup",N,false);window.removeEventListener("keydown",C,false)};this.domElement.addEventListener("contextmenu",U,false);this.domElement.addEventListener("mousedown",O,false);this.domElement.addEventListener("mousemove",L,false);this.domElement.addEventListener("mousewheel",b,false);this.domElement.addEventListener("MozMousePixelScroll",b,false);this.domElement.addEventListener("touchstart",D,false);this.domElement.addEventListener("touchend",F,false);this.domElement.addEventListener("touchmove",M,false);window.addEventListener("keydown",C,false);this.update()};THREE.FollowOrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.FollowOrbitControls.prototype.constructor=THREE.FollowOrbitControls;Object.defineProperties(THREE.FollowOrbitControls.prototype,{object:{get:function(){return this.constraint.object}},velocityRequest:{get:function(){return this.constraint.velocityRequest}},target:{get:function(){return this.constraint.target},set:function(e){this.constraint.target=e}},minDistance:{get:function(){return this.constraint.minDistance},set:function(e){this.constraint.minDistance=e}},maxDistance:{get:function(){return this.constraint.maxDistance},set:function(e){this.constraint.maxDistance=e}},minZoom:{get:function(){return this.constraint.minZoom},set:function(e){this.constraint.minZoom=e}},maxZoom:{get:function(){return this.constraint.maxZoom},set:function(e){this.constraint.maxZoom=e}},minPolarAngle:{get:function(){return this.constraint.minPolarAngle},set:function(e){this.constraint.minPolarAngle=e}},maxPolarAngle:{get:function(){return this.constraint.maxPolarAngle},set:function(e){this.constraint.maxPolarAngle=e}},minAzimuthAngle:{get:function(){return this.constraint.minAzimuthAngle},set:function(e){this.constraint.minAzimuthAngle=e}},maxAzimuthAngle:{get:function(){return this.constraint.maxAzimuthAngle},set:function(e){this.constraint.maxAzimuthAngle=e}},enableDamping:{get:function(){return this.constraint.enableDamping},set:function(e){this.constraint.enableDamping=e}},dampingFactor:{get:function(){return this.constraint.dampingFactor},set:function(e){this.constraint.dampingFactor=e}},noZoom:{get:function(){console.warn("THREE.FollowOrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");return!this.enableZoom},set:function(e){console.warn("THREE.FollowOrbitControls: .noZoom has been deprecated. Use .enableZoom instead.");this.enableZoom=!e}},noRotate:{get:function(){console.warn("THREE.FollowOrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");return!this.enableRotate},set:function(e){console.warn("THREE.FollowOrbitControls: .noRotate has been deprecated. Use .enableRotate instead.");this.enableRotate=!e}},noPan:{get:function(){console.warn("THREE.FollowOrbitControls: .noPan has been deprecated. Use .enablePan instead.");return!this.enablePan},set:function(e){console.warn("THREE.FollowOrbitControls: .noPan has been deprecated. Use .enablePan instead.");this.enablePan=!e}},noKeys:{get:function(){console.warn("THREE.FollowOrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");return!this.enableKeys},set:function(e){console.warn("THREE.FollowOrbitControls: .noKeys has been deprecated. Use .enableKeys instead.");this.enableKeys=!e}},staticMoving:{get:function(){console.warn("THREE.FollowOrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");return!this.constraint.enableDamping},set:function(e){console.warn("THREE.FollowOrbitControls: .staticMoving has been deprecated. Use .enableDamping instead.");this.constraint.enableDamping=!e}},dynamicDampingFactor:{get:function(){console.warn("THREE.FollowOrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");return this.constraint.dampingFactor},set:function(e){console.warn("THREE.FollowOrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead.");this.constraint.dampingFactor=e}}})})();THREE.TrackballControls=function(t,n){var o=this;var s={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=t;this.domElement=n!==undefined?n:document;this.enabled=true;this.screen={left:0,top:0,width:0,height:0};this.rotateSpeed=1;this.zoomSpeed=1.2;this.panSpeed=.3;this.noRotate=false;this.noZoom=false;this.noPan=false;this.staticMoving=false;this.dynamicDampingFactor=0;this.minDistance=0;this.maxDistance=Infinity;this.keys=[65,83,68];this.velocityRequest=new THREE.Vector3;this.target=new THREE.Vector3;this.follow_controls_on=r.STEERING.NAME==="FOLLOW";var l=1e-6;var c=new THREE.Vector3;var u=s.NONE,p=s.NONE,h=new THREE.Vector3,d=new THREE.Vector2,f=new THREE.Vector2,m=new THREE.Vector3,_=0,E=new THREE.Vector2,v=new THREE.Vector2,y=0,g=0,A=new THREE.Vector2,S=new THREE.Vector2;this.target0=this.target.clone();this.position0=this.object.position.clone();this.up0=this.object.up.clone();var w={type:"change"};var I={type:"start"};var R={type:"end"};this.handleResize=function(){if(this.domElement===document){this.screen.left=0;this.screen.top=0;this.screen.width=window.innerWidth;this.screen.height=window.innerHeight}else{var e=this.domElement.getBoundingClientRect();var t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft;this.screen.top=e.top+window.pageYOffset-t.clientTop;this.screen.width=e.width;this.screen.height=e.height}};this.handleEvent=function(e){if(typeof this[e.type]=="function"){this[e.type](e)}};var T=function(){var e=new THREE.Vector2;return function t(i,n){e.set(r.X_AXIS_MULT*(i-o.screen.left)/o.screen.width,r.Y_AXIS_MULT*(n-o.screen.top)/o.screen.height);return e}}();var O=function(){var e=new THREE.Vector2;return function t(i,n){e.set(r.X_AXIS_MULT*((i-o.screen.width*.5-o.screen.left)/(o.screen.width*.5)),r.Y_AXIS_MULT*((o.screen.height+2*(o.screen.top-n))/o.screen.width));return e}}();this.rotateCamera=function(){var t=new THREE.Vector3,i=new THREE.Quaternion,r=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,c=new THREE.Vector2,u,p=0;return function u(){if(o.follow_controls_on){c.set(f.x,f.y);var E=c.length();c.normalize().multiplyScalar(a.slopewell(E));l.set(c.x,c.y,0);d.set(0,0);p+=l.length()*e.LagScale.get()}else{l.set(f.x-d.x,f.y-d.y,0);p=l.length()}if(p){h.copy(o.object.position).sub(o.target);r.copy(h).normalize();n.copy(o.object.up).normalize();s.crossVectors(n,r).normalize();n.setLength(f.y-d.y);s.setLength(f.x-d.x);l.copy(n.add(s));t.crossVectors(l,h).normalize();p*=o.rotateSpeed;i.setFromAxisAngle(t,p);h.applyQuaternion(i);o.object.up.applyQuaternion(i);m.copy(t);_=p}else if(!o.staticMoving&&_){_*=Math.sqrt(1-o.dynamicDampingFactor);h.copy(o.object.position).sub(o.target);i.setFromAxisAngle(m,_);h.applyQuaternion(i);o.object.up.applyQuaternion(i)}d.copy(f)}}();this.zoomCamera=function(){var e;if(u===s.TOUCH_ZOOM_PAN){e=y/g;y=g;h.multiplyScalar(e)}else{e=1+(v.y-E.y)*o.zoomSpeed;if(e!==1&&e>0){h.multiplyScalar(e);if(o.staticMoving){E.copy(v)}else{E.y+=(v.y-E.y)*this.dynamicDampingFactor}}}};this.panCamera=function(){var e=new THREE.Vector2,t=new THREE.Vector3,i=new THREE.Vector3;return function r(){e.copy(S).sub(A);if(e.lengthSq()){e.multiplyScalar(h.length()*o.panSpeed);i.copy(h).cross(o.object.up).setLength(e.x);i.add(t.copy(o.object.up).setLength(e.y));o.object.position.add(i);o.target.add(i);if(o.staticMoving){A.copy(S)}else{A.add(e.subVectors(S,A).multiplyScalar(o.dynamicDampingFactor))}}}}();this.checkDistances=function(){if(!o.noZoom||!o.noPan){if(h.lengthSq()>o.maxDistance*o.maxDistance){o.object.position.addVectors(o.target,h.setLength(o.maxDistance));E.copy(v)}if(h.lengthSq()<o.minDistance*o.minDistance){o.object.position.addVectors(o.target,h.setLength(o.minDistance));E.copy(v)}}};this.update=function(){h.subVectors(o.object.position,o.target);if(!o.noRotate){o.rotateCamera()}if(!o.noZoom){o.zoomCamera()}if(!o.noPan){o.panCamera()}o.object.position.addVectors(o.target,h);o.checkDistances();o.object.lookAt(o.target);if(c.distanceToSquared(o.object.position)>l){o.dispatchEvent(w);c.copy(o.object.position)}};this.reset=function(){u=s.NONE;p=s.NONE;o.target.copy(o.target0);o.object.position.copy(o.position0);o.object.up.copy(o.up0);h.subVectors(o.object.position,o.target);o.object.lookAt(o.target);o.dispatchEvent(w);c.copy(o.object.position)};function P(e){if(o.enabled===false)return;window.removeEventListener("keydown",P);p=u;if(u!==s.NONE){return}else if(e.keyCode===o.keys[s.ROTATE]&&!o.noRotate){u=s.ROTATE}else if(e.keyCode===o.keys[s.ZOOM]&&!o.noZoom){u=s.ZOOM}else if(e.keyCode===o.keys[s.PAN]&&!o.noPan){u=s.PAN}}function L(e){if(o.enabled===false)return;u=p;window.addEventListener("keydown",P,false)}function N(e){if(o.enabled===false)return;e.preventDefault();e.stopPropagation();if(u===s.NONE){u=e.button}if(u===s.ROTATE&&!o.noRotate){f.copy(O(e.pageX,e.pageY));d.copy(f)}else if(u===s.ZOOM&&!o.noZoom){E.copy(T(e.pageX,e.pageY));v.copy(E)}else if(u===s.PAN&&!o.noPan){A.copy(T(e.pageX,e.pageY));S.copy(A)}if(!o.follow_controls_on){document.addEventListener("mousemove",b,false);document.addEventListener("mouseup",C,false)}o.dispatchEvent(I)}function b(e){if(o.enabled===false)return;e.preventDefault();e.stopPropagation();if(u===s.ROTATE&&!o.noRotate||o.follow_controls_on){d.copy(f);f.copy(O(e.pageX,e.pageY))}else if(u===s.ZOOM&&!o.noZoom){v.copy(T(e.pageX,e.pageY))}else if(u===s.PAN&&!o.noPan){S.copy(T(e.pageX,e.pageY))}}function C(e){if(o.enabled===false)return;e.preventDefault();e.stopPropagation();u=s.NONE;if(!o.follow_controls_on){document.removeEventListener("mousemove",b);document.removeEventListener("mouseup",C)}o.dispatchEvent(R)}function D(e){if(o.enabled===false)return;e.preventDefault();e.stopPropagation();var t=0;if(e.wheelDelta){t=e.wheelDelta/40}else if(e.detail){t=-e.detail/3}E.y+=t*.01;o.dispatchEvent(I);o.dispatchEvent(R)}function M(e){if(o.enabled===false)return;switch(e.touches.length){case 1:u=s.TOUCH_ROTATE;f.copy(O(e.touches[0].pageX,e.touches[0].pageY));d.copy(f);break;case 2:u=s.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX;var i=e.touches[0].pageY-e.touches[1].pageY;g=y=Math.sqrt(t*t+i*i);var r=(e.touches[0].pageX+e.touches[1].pageX)/2;var n=(e.touches[0].pageY+e.touches[1].pageY)/2;A.copy(T(r,n));S.copy(A);break;default:u=s.NONE}o.dispatchEvent(I)}function F(e){if(o.enabled===false)return;e.preventDefault();e.stopPropagation();switch(e.touches.length){case 1:d.copy(f);f.copy(O(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX;var i=e.touches[0].pageY-e.touches[1].pageY;g=Math.sqrt(t*t+i*i);var r=(e.touches[0].pageX+e.touches[1].pageX)/2;var n=(e.touches[0].pageY+e.touches[1].pageY)/2;S.copy(T(r,n));break;default:u=s.NONE}}function U(e){if(o.enabled===false)return;switch(e.touches.length){case 1:d.copy(f);f.copy(O(e.touches[0].pageX,e.touches[0].pageY));break;case 2:y=g=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2;var i=(e.touches[0].pageY+e.touches[1].pageY)/2;S.copy(T(t,i));A.copy(S);break}u=s.NONE;o.dispatchEvent(R)}function k(e){e.preventDefault()}this.dispose=function(){this.domElement.removeEventListener("contextmenu",k,false);this.domElement.removeEventListener("mousedown",N,false);this.domElement.removeEventListener("mousewheel",D,false);this.domElement.removeEventListener("MozMousePixelScroll",D,false);this.domElement.removeEventListener("touchstart",M,false);this.domElement.removeEventListener("touchend",U,false);this.domElement.removeEventListener("touchmove",F,false);document.removeEventListener("mousemove",b,false);document.removeEventListener("mouseup",C,false);window.removeEventListener("keydown",P,false);window.removeEventListener("keyup",L,false)};this.domElement.addEventListener("contextmenu",k,false);if(!this.follow_controls_on){
this.domElement.addEventListener("mousedown",N,false)}this.domElement.addEventListener("mousemove",b,false);this.domElement.addEventListener("mousewheel",D,false);this.domElement.addEventListener("MozMousePixelScroll",D,false);this.domElement.addEventListener("touchstart",M,false);this.domElement.addEventListener("touchend",U,false);this.domElement.addEventListener("touchmove",F,false);window.addEventListener("keydown",P,false);window.addEventListener("keyup",L,false);window.addEventListener("resize",i.throttle(this.handleResize.bind(this),50));this.handleResize();this.update()};THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.TrackballControls.prototype.constructor=THREE.TrackballControls;var t=typeof module!=="undefined"&&module.exports;if(t)var r=require("./config.js");if(t)var i=require("lodash");if(t)var o=require("xss-filters");var a={};a.clamp=function e(t,i,r){if(i>r)throw new Error("invalid clamp, min is greater than max");return Math.min(Math.max(t,i),r)};a.getRandomIntInclusive=function e(t,i){return Math.floor(Math.random()*(i-t+1))+t};a.getRandomArbitrary=function e(t,i){return Math.random()*(i-t)+t};a.validNick=function e(t){var i=/^\w*$/;return i.exec(t)!==null};a.getSizePercentage=function e(t){var i=t*1/r.MAX_PLAYER_RADIUS;return i};a.toVector3=function e(t,i){t[i]=(new THREE.Vector3).copy(t[i])};function s(e,t,i,r,n){return e[n]+t-i[n]>r[n]/2}function l(e,t,i,r,n){return e[n]-t-i[n]<-r[n]/2}function c(e,t,i,r){return s(e,t,i,r,"x")}function u(e,t,i,r){return l(e,t,i,r,"x")}function p(e,t,i,r){return s(e,t,i,r,"y")}function h(e,t,i,r){return l(e,t,i,r,"y")}function d(e,t,i,r){return s(e,t,i,r,"z")}function f(e,t,i,r){return l(e,t,i,r,"z")}a.checkWallCollision=function e(t,i,r,n){return c(t,i,r,n)||u(t,i,r,n)||p(t,i,r,n)||h(t,i,r,n)||d(t,i,r,n)||f(t,i,r,n)};a.adjustVelocityWallHit=function e(t,i,r,n){var o=r.clone();if(c(t,i,r,n)||u(t,i,r,n))o.x=0;if(p(t,i,r,n)||h(t,i,r,n))o.y=0;if(d(t,i,r,n)||f(t,i,r,n))o.z=0;return o};a.slopewell=function e(t){return Math.max(0,(-r.STEERING.WELL+t)/r.STEERING.SLOPE)};a.safeRandomCoordinate=function e(){var t=arguments[0]||Math.random();var i=r.WORLD_SIZE-2*r.INITIAL_PLAYER_RADIUS;return t*i-i/2};a.safePlayerPosition=function e(){var t=a.safeRandomCoordinate();var i=a.safeRandomCoordinate();var r=a.safeRandomCoordinate();return new THREE.Vector3(t,i,r)};a.trimPosition=function e(t,i){return{x:+t.x.toFixed(i),y:+t.y.toFixed(i),z:+t.z.toFixed(i)}};a.fourPad=function e(t){return t+(4-t%4)};a.trimFloat=function e(t,i){return+t.toFixed(i)};a.sortedObjectPush=function e(t,r,n){t.splice(i.sortedIndexBy(t,r,n),0,r)};a.getFoodCrayon=function e(t){return m[t]};var m={random:function e(){return{r:a.getRandomIntInclusive(0,255)/255,g:a.getRandomIntInclusive(0,255)/255,b:a.getRandomIntInclusive(0,255)/255}},hsl01:function e(t,i,n){var o=(t+i+n)/(2*r.WORLD_SIZE);var a=1;var s=.6;var l=(new THREE.Color).setHSL(o,a,s);return{r:l.r,g:l.g,b:l.b}},rgbcube:function e(t,i,n){return{r:.5+t/r.WORLD_SIZE,g:.5+i/r.WORLD_SIZE,b:.5+n/r.WORLD_SIZE}},"rgbcube-randomized":function e(t,i,n){return{r:.5+t/r.WORLD_SIZE+a.getRandomIntInclusive(-128,128)/512,g:.5+i/r.WORLD_SIZE+a.getRandomIntInclusive(-128,128)/512,b:.5+n/r.WORLD_SIZE+a.getRandomIntInclusive(-128,128)/512}},octant:function e(t,i,r){var n,o,a;if(t>=0&&i>=0&&r>=0){n=1;o=0;a=0}else if(t<0&&i>=0&&r>=0){n=0;o=1;a=0}else if(t<0&&i<0&&r>=0){n=0;o=0;a=1}else if(t>=0&&i<0&&r>=0){n=1;o=1;a=0}else if(t>=0&&i>=0&&r<0){n=0;o=1;a=1}else if(t<0&&i>=0&&r<0){n=1;o=1;a=1}else if(t<0&&i<0&&r<0){n=1;o=0;a=1}else if(t>=0&&i<0&&r<0){n=.5;o=0;a=.1}return{r:n,g:o,b:a}},"sine-cycle":function e(t,i,n){return{r:Math.sin(t/(r.WORLD_SIZE/r.FOOD_COLORING_SINE_SEGMENTS))/2+1/2,g:Math.sin(i/(r.WORLD_SIZE/r.FOOD_COLORING_SINE_SEGMENTS))/2+1/2,b:Math.sin(n/(r.WORLD_SIZE/r.FOOD_COLORING_SINE_SEGMENTS))/2+1/2}}};a.getFoodMap=function e(t){return _[t]};var _={random:function e(t,i){var n=r.WORLD_SIZE/2;var o=r.WORLD_SIZE/i;var s=3;var l=0;var c=new Int16Array(t*3);for(var u=1;u<i;++u){for(var p=1;p<i;++p){for(var h=1;h<i;++h){var d=n-u*o+a.getRandomIntInclusive(-o,o);var f=n-p*o+a.getRandomIntInclusive(-o,o);var m=n-h*o+a.getRandomIntInclusive(-o,o);c[l]=d;c[l+1]=f;c[l+2]=m;l+=s}}}return c},grid:function e(t,i){var n=r.WORLD_SIZE/2;var o=r.WORLD_SIZE/i;var a=3;var s=0;var l=new Int16Array(t*3);for(var c=1;c<i;++c){for(var u=1;u<i;++u){for(var p=1;p<i;++p){var h=n-c*o;var d=n-u*o;var f=n-p*o;l[s]=h;l[s+1]=d;l[s+2]=f;s+=a}}}return l}};a.nth=function e(t,i){var r=0;var n=Math.max(i,0);return function(){if(r===n){r=0;return t.apply(this,arguments)}else{r++}}};a.isBlank=function e(t){return!t||/^\s*$/.test(t)};a.pushShift=function e(t,i,r){t.push(i);if(t.length>r){t.shift()}};a.toArrayBuffer=function e(t){var i=new ArrayBuffer(t.length);var r=new Uint8Array(i);for(var n=0;n<t.length;++n){r[n]=t[n]}return i};a.findIndexById=function e(t,r){return i.findIndex(t,function(e){return e.id==r})};a.readFirstByte=function e(t){var i=new Uint8Array(t);return i[0]};a.readFirstFloat=function e(t){var i=new Float32Array(t);return i[0]};a.logTime=function e(t,i,r){console.log(t,(r-i).toFixed(3))};a.filterName=function e(t){var i=o.inHTMLData(t);if(a.isBlank(i)){i="Guest"}else if(t.length>r.MAX_PLAYER_NAME_LENGTH){i=i.substr(0,r.MAX_PLAYER_NAME_LENGTH)}return i};a.lerp=function e(t,i,r){return(1-r)*t+r*i};if(t)module.exports=a;var t=typeof module!=="undefined"&&module.exports;if(t)var THREE=require("three");if(t)var a=require("./util.js");if(t)var r=require("./config.js");if(t)var i=require("lodash");var e=e||{};e.Model=function e(){this.actors=[];this.players=[];this.leaders=[]};e.Model.prototype.init=function e(t,i){this.worldSize=new THREE.Vector3(t,t,t);this.foodDensity=i;if(i>0){this.initFood()}};e.Model.prototype.initFood=function e(){this.foodCount=Math.pow(this.foodDensity-1,3);this.food_respawning=new Uint32Array(this.foodCount);this.food_respawning_indexes=[];this.food_captured_queue=[];this.food_respawn_ready_queue=[];var t=a.getFoodMap(r.FOOD_MAP_TYPE);this.food=t(this.foodCount,this.foodDensity)};e.Model.prototype.addActor=function e(t){if(!t.id){throw"Actors must have an ID"}this.actors.push(t)};e.Model.prototype.reduce=function e(){return{actors:this.reduceObjects(this.actors),players:this.reduceObjects(this.players),worldSize:this.worldSize,food:this.food,foodCount:this.foodCount,foodDensity:this.foodDensity,food_respawning:this.food_respawning,food_respawn_ready_queue:this.food_respawn_ready_queue,food_respawning_indexes:this.food_respawning_indexes}};e.Model.prototype.reduceObjects=function e(t,i){var r=[];t.forEach(function e(t){r.push(t.reduce(i))});return r};e.Model.prototype.reduceActors=function e(t){return this.reduceObjects(this.actors,t)};e.Model.prototype.getActorById=function e(t){return this.actors[a.findIndexById(this.actors,t)]};e.Model.prototype.getPlayerById=function e(t){return this.players[a.findIndexById(this.players,t)]};e.Model.prototype.getRealPlayers=function t(){var i=[];for(var r=0,n=this.players.length;r<n;r++){var o=this.players[r];if(o.type===e.PlayerTypes.PLAYER){i.push(o)}}return i};e.Model.prototype.removePlayer=function e(t){var r=a.findIndexById(this.players,t);var n=this.players[r];var o=i.findIndex(this.actors,function(e){return e.playerId==t});var s=this.actors[o];if(n){o=a.findIndexById(this.actors,n.sphere.id);s=this.actors[o];this.players.splice(r,1)}if(s){this.actors.splice(o,1)}};e.ActorTypes=Object.freeze({UNDEFINED:"UNDEFINED",PLAYER_SPHERE:"PLAYER_SPHERE",FOOD:"FOOD",PORTAL:"PORTAL",OBSTACLE:"OBSTACLE",SPECTATOR:"SPECTATOR"});e.Actor=function t(){this.position=new THREE.Vector3(0,0,0);this.velocity=new THREE.Vector3(0,0,0);this.scale=1;this.type=e.ActorTypes.UNDEFINED;this.recentPositions=[]};e.Actor.prototype.reduce=function e(){return this};e.Actor.prototype.pushRecentPosition=function e(t){t.position=new THREE.Vector3(t.position.x,t.position.y,t.position.z);if(this.recentPositions.length===0){this.recentPositions.push(t)}else{var i=this.recentPositions[this.recentPositions.length-1].time;var n=t.time;if(n>i){this.recentPositions.push(t);while(this.recentPositions.length>r.PLAYER_POSITIONS_WINDOW){this.recentPositions.shift()}}}};e.PlayerSphere=function t(i,n,o,s,l,c){e.Actor.call(this);this.type=e.ActorTypes.PLAYER_SPHERE;if(o){this.position=new THREE.Vector3(o.x,o.y,o.z)}if(s){this.scale=s;this.expectedScale=s}else{this.scale=r.INITIAL_PLAYER_RADIUS;this.expectedScale=r.INITIAL_PLAYER_RADIUS}if(l){this.velocity=l;a.toVector3(this,"velocity")}else{this.velocity={x:0,y:0,z:0}}this.color=n;this.skin=c;this.drain_target_id=0;this.speed_boosting=false;this.playerId=i;this.id=this.playerId};e.PlayerSphere.prototype=Object.create(e.Actor.prototype);e.PlayerSphere.constructor=e.PlayerSphere;e.PlayerSphere.prototype.reduce=function e(t){var i=t||false;var r={id:this.id,position:this.position,velocity:this.velocity,scale:this.scale,drain_target_id:this.drain_target_id,speed_boosting:this.speed_boosting};if(!i){r.type=this.type;r.color=this.color;r.skin=this.skin;r.playerId=this.playerId}return r};e.PlayerSphere.prototype.radius=function e(){return this.scale};e.PlayerSphere.prototype.growExpected=function e(t){this.expectedScale+=t;if(this.expectedScale>r.MAX_PLAYER_RADIUS){this.expectedScale=r.MAX_PLAYER_RADIUS}else if(this.expectedScale<r.INITIAL_PLAYER_RADIUS){this.expectedScale=r.INITIAL_PLAYER_RADIUS}this.scale=this.expectedScale};e.PlayerTypes=Object.freeze({SPECTATOR:"SPECTATOR",PLAYER:"PLAYER",BOT:"BOT"});e.Player=function t(i,r,n,o,a,s,l,c){var u=this;this.id=i;this.name=r;this.type=o;this.createdTime=this.lastHeartbeat=Date.now();this.sphere=new e.PlayerSphere(this.id,n,a,s,l,c);this.abilities={};this.abilities.speed_boost=new e.SpeedBoostAbility(this.sphere);this.abilities.speed_boost.on("deactivate",function(){u.sphere.recentPositions=[]});this.foodCaptures=0;this.playerCaptures=0;this.drainAmount=0;this.spawnTime=0;this.deathTime=0;this.infractions_food=0;this.infractions_pcap=0;this.infractions_speed=0;this.infractions_scale=0;this.ping_metric=new e.Metric(100);this.fps_metric=new e.Metric(20,true);this.pp_send_metric=new e.Metric(200);this.pp_receive_metric=new e.Metric(200);this.au_receive_metric=new e.Metric(200);this.buffered_amount_metric=new e.Metric(320)};e.Player.prototype.reduce=function e(){return{id:this.id,name:this.name,type:this.type,sphere:this.sphere.reduce()}};e.Player.prototype.getMetrics=function e(){var t=this.reduce();t.ping=this.ping_metric;t.fps=this.fps_metric;t.pp_send=this.pp_send_metric;t.pp_receive=this.pp_receive_metric;t.au_receive=this.au_receive_metric;t.buffered_amount=this.buffered_amount_metric;return t};e.Player.prototype.getScore=function e(){return r.PLAYER_GET_SCORE(this.sphere.scale)};e.Player.prototype.getSpeed=function e(){var t=r.PLAYER_GET_SPEED(this.sphere.scale);if(this.abilities.speed_boost.isActive()){t=t*r.ABILITY_SPEED_BOOST_MULTIPLIER}return t};e.Player.prototype.getCaptureRange=function e(){return this.getSpeed()*3+this.sphere.scale*2+10};e.Player.prototype.update=function e(){var t=Object.getOwnPropertyNames(this.abilities);for(var i=0,r=t.length;i<r;i++){var n=this.abilities[t[i]];n.update()}};e.Metric=function e(t,i){this.threshold=t;this.reverse_threshold=i||false;this.last_time=Date.now();this.series=[];this.mean=0;this.max=0;this.min=0;this.last=0;this.threshold_exceeded_count=0};e.Metric.prototype.add=function e(t){t=+t;a.pushShift(this.series,t,r.RECENT_CLIENT_DATA_LENGTH);this.last=t;this.mean=+i.mean(this.series).toFixed(3);this.max=i.max(this.series);this.min=i.min(this.series);if(this.reverse_threshold){if(t<this.threshold){this.threshold_exceeded_count++}}else{if(t>this.threshold){this.threshold_exceeded_count++}}};e.Ability=function e(){var t=this;this.isActive=undefined;this.activate=undefined;this.deactivate=undefined;this.isReady=undefined;this.update=undefined;t.events={activate:[],deactivate:[],update:[]};this.on=function e(i,r){t.events[i].push(r)}};e.SpeedBoostAbility=function t(i){this.sphere=i;e.Ability.call(this);this.active=false;this.min_scale=r.ABILITY_SPEED_BOOST_MIN_SCALE;this.active_duration=0;this.start_time=undefined;this.cooldown_delay=0;this.isReady=function e(){return!this.active&&this.sphere.scale>this.min_scale};this.isActive=function e(){return this.active};this.activate=function e(){if(!this.isReady())return false;this.active=true;this.start_time=Date.now()-this.active_duration;this.sphere.speed_boosting=true;this.cooldown_delay=1e3;for(var t=0;t<this.events.activate.length;t++){if(typeof this.events.activate[t]==="function"){this.events.activate[t]()}}return true};this.deactivate=function e(){this.active=false;this.sphere.speed_boosting=false;this.start_time=undefined;for(var t=0;t<this.events.deactivate.length;t++){if(typeof this.events.deactivate[t]==="function"){this.events.deactivate[t]()}}};this.update=function e(){if(!this.active){if(this.cooldown_delay>0){this.cooldown_delay=Math.max(this.cooldown_delay-r.TICK_FAST_INTERVAL,0)}else if(this.active_duration>0){this.active_duration=Math.max(this.active_duration-r.TICK_FAST_INTERVAL,0)}return}this.active_duration=Date.now()-this.start_time;for(var t=0;t<this.events.update.length;t++){if(typeof this.events.update[t]==="function"){this.events.update[t]()}}}};e.SpeedBoostAbility.prototype=Object.create(e.Ability.prototype);e.SpeedBoostAbility.constructor=e.SpeedBoostAbility;e.lock={};e.expireLocks=function t(){var i=Object.getOwnPropertyNames(e.lock);for(var n=0,o=i.length;n<o;n++){var a=i[n];if(e.lock[a]>0){console.log("Lock expiring in: ",a,e.lock[a]);e.lock[a]-=r.TICK_SLOW_INTERVAL}else{console.log("lock expired:",a);delete e.lock[a]}}};e.IdGenerator=function e(){var t=0;function i(){return++t}return{get_next_id:i}}();if(t)module.exports=e;var t=typeof module!=="undefined"&&module.exports;if(t)var E=require("schemapack");var e=e||{};e.Schemas=function e(){var t={x:"float32",y:"float32",z:"float32"};var i={id:"varuint",position:t,velocity:t,scale:"float32",drain_target_id:"varuint",speed_boosting:"boolean",type:"string",color:"uint8",skin:"string",playerId:"varuint"};var r={id:"varuint",position:t,velocity:t,scale:"float32",drain_target_id:"varuint",speed_boosting:"boolean"};var n={id:"varuint",name:"string",type:"string",sphere:i};var o={actors:[i],players:[n],worldSize:{x:"uint16",y:"uint16",z:"uint16"},food:["int16"],foodCount:"uint32",foodDensity:"uint8",food_respawning:["varuint"],food_respawn_ready_queue:["varuint"],food_respawning_indexes:["varuint"]};var a={player_id:"varuint",score:"varuint"};var s={fr:["varuint"],fc:["varuint"],sm:"string",leaders:[a]};var l={position:t,radius:"float32",time:"varuint"};var c={fi:"varuint",radius:"float32"};var u={0:"uint8",NB_SRVID:"string",model:o};var p={0:"uint8",player:n};var h={0:"uint8",actors:[r]};var d={0:"uint8",player_id:"varuint",sphere_id:"varuint",pp_gap:"varuint",au_gap:"varuint",buffered_mount:"varuint",latest_position:l,prev_position_1:l,prev_position_2:l,prev_position_3:l,oldest_position:l,food_capture_queue:[c]};var f={0:"uint8",attacking_player_id:"varuint",food_captures:"varuint",player_captures:"varuint",drain_ammount:"varuint",time_alive:"varuint",score:"varuint"};var m={0:"uint8",tick_data:s};var _={INIT_GAME:1,ACTOR_UPDATES:2,PLAYER_UPDATE:3,TICK_SLOW:4,YOU_DIED:5,WELCOME:6,CLIENT_POSITION_RAPID:7};return{ops:_,initGameSchema:E.build(u),actorUpdatesSchema:E.build(h),playerUdateSchema:E.build(d),tickSlowSchema:E.build(m),youDied:E.build(f),welcomeSchema:E.build(p)}}();if(t)module.exports=e.Schemas;var e=e||{};e.LagScale=function e(){var t=1/60*1e3;var i=a();var n=1;var o=t/1e3;function a(){return Date.now()}function s(){if(r.LAG_SCALE_ENABLE){var e=a();var s=e-i;var l=1/(s/1e3);i=e;n=s/t;o=.2*l+.8*o}}function l(){return n}function c(){return o}return{update:s,get:l,get_fps:c}}();var e=e||{};e.Sounds=function e(){function t(e,t){return new Howl({src:["../sfx/"+e],autoplay:false,loop:false,volume:r.VOLUME_SFX_INITIAL,buffer:false,preload:true,volume:t||.1})}var i={sfx:{food_capture:{A3:t("food_capture/A3.mp3"),A4:t("food_capture/A4.mp3"),B3:t("food_capture/B3.mp3"),B4:t("food_capture/B4.mp3"),D3:t("food_capture/D3.mp3"),D4:t("food_capture/D4.mp3"),E3:t("food_capture/E3.mp3"),E4:t("food_capture/E4.mp3"),G3:t("food_capture/G3.mp3"),G4:t("food_capture/G4.mp3"),Gb3:t("food_capture/Gb3.mp3")},woosh:new Wad({source:"noise",volume:.35,env:{attack:.5,decay:.5,sustain:1,hold:3600,release:.5},filter:{type:"lowpass",frequency:300,q:1}}),state_change:t("food_capture/D3.mp3"),player_capture:t("player_capture.wav",.8)},playFromPos:function e(t,i,n){var o=i.position.distanceTo(n);var a=i.worldToLocal(n).normalize().multiplyScalar(o/r.VOLUME_FALLOFF_RATE);var s=t.play();t.pos(a.x,a.y,a.z,s)}};if(!r.MUSIC_ENABLED){i.music={}}return i}();var e=e||{};e.UI=function t(){var n;var o=false;var a=["json","websockets","webgl","flexbox"];var s={INITIAL:"menu-game-screen",MENU_SCREEN:"menu-game-screen",MENU_GAME_SCREEN:"menu-game-screen",MENU_STORE_SCREEN:"menu-store-screen",MENU_CONFIG_SCREEN:"menu-config-screen",PLAYING:"playing",PLAYING_CONFIG:"playing-config",RESPAWN_SCREEN:"respawn-screen",KICKED_SCREEN:"kicked-screen",GAME_INIT_ERROR:"game-init-error",SERVER_MSG_SCREEN:"server-msg-screen",CREDITS_SCREEN:"credits-screen",TUTORIAL_SCREEN:"tutorial-screen"};var l={PLAYER_LOGIN_KEYPRESS:"player-login-keypress",PLAYER_LOGIN:"player-login",PLAYER_RESPAWN:"player-respawn",PAGE_RELOAD:"page-reload",SHOW_CREDITS:"show-credits",SHOW_MENU:"show-menu",SHOW_TUTORIAL:"show-tutorial",SHOW_PLAYING_CONFIG:"show-playing-config",SHOW_PREVIOUS:"show-previous",SHOW_MENU_GAME_SCREEN:"show-menu-game-screen ",SHOW_MENU_STORE_SCREEN:"show-menu-store-screen ",SHOW_MENU_CONFIG_SCREEN:"show-menu-config-screen ",TOGGLE_Y_AXIS:"toggle-y-axis",TOGGLE_X_AXIS:"toggle-x-axis",TOGGLE_OWN_TRAIL:"toggle-own-trail",VOLUME_MUSIC:"volume-music",VOLUME_SFX:"volume-sfx",SET_SKIN:"set-skin"};var c={state:"",prev_state:s.INITIAL,STATES:s,ACTIONS:l,COLORS:r.COLORS,REQUIRE_ALPHA_KEY:r.REQUIRE_ALPHA_KEY,DEBUG:r.DEBUG,MISSING_FEATURES:[],AUTHORS:["Michael Clayton","Jared Sprague"],skins:i(e.PlayerSkins).map(i.partial(i.pick,i,"meta")).sortBy("meta.sort").value(),selected_skin:localStorage.skin||"default",leaders:[],is_mobile:isMobile.any,screen_x:0,screen_y:0,flip_x:JSON.parse(localStorage.flip_x||"false"),flip_y:JSON.parse(localStorage.flip_y||"false"),hide_own_trail:JSON.parse(localStorage.hide_own_trail||"false"),music_enabled:r.MUSIC_ENABLED,volume:{music:r.VOLUME_MUSIC_INITIAL,sfx:r.VOLUME_SFX_INITIAL}};var u={STATES:s,ACTIONS:l,data:c,state:E,on:v,clearTarget:d,setAndSave:f};var p=[];var h=s.INITIAL;function d(){c.target=undefined}function f(e,t){n.set(e,t);localStorage.setItem(e,t)}function m(e){var t=e.id.replace("-template","");n.partials[t]=e.textContent}function _(e){return i.includes(i.values(s),e)}function E(t){if(!t)return c.state;if(t===E()){return}else{e.Sounds.sfx.state_change.play()}if(t!==c.prev_state){c.prev_state=c.state}if(typeof t!=="undefined"&&_(t)){console.log("entering state "+t);c.state=t;n.update()}ga("send",{hitType:"event",eventCategory:"StateChange",eventAction:t});return c.state}function v(e,t){if(e==="init"){if(o){t.call(this)}else{p.push(t.bind(this))}}else{n.on(e,t)}}function y(){var e=i.chain(g()).keys().union(r.BROWSER_FORCE_DISABLED_FEATURES).intersection(a).value();i.assign(c.MISSING_FEATURES,e);if(e.length){console.log("Missing browser feature(s): "+JSON.stringify(e))}if(e.length){E(s.GAME_INIT_ERROR)}}function g(){return i.chain(Modernizr).forOwn().omitBy().value()}function A(){n.set("screen_x",window.innerWidth);n.set("screen_y",window.innerHeight)}function S(){Ractive.DEBUG=r.DEBUG;n=new Ractive({el:"#ui-overlay",template:"#ui-template",data:c});u.engine=n;u.update=R();y();i.each(document.querySelectorAll('script[type="text/ractive"]'),m);E(s.INITIAL);I();i.invokeMap(p,i.call);n.el.classList.add("active");var e=c.skins.length;while(e--){var t=c.skins[e];if(t.meta.unlock_url&&t.meta.unlock_url!=window.location.search){c.skins.splice(e,1)}}o=true;A();window.addEventListener("resize",A,false)}function w(e){return function(){E(e)}}function I(){if(localStorage.alpha_key){n.set("alpha_key",localStorage.alpha_key)}if(localStorage.player_name){n.set("player_name",localStorage.player_name)}v(l.VOLUME_MUSIC,function t(){var i=this.get("volume.music");e.Sounds.music.background.volume(i);localStorage.volume_music=i});v(l.VOLUME_SFX,function t(){var r=this.get("volume.sfx");i.each(e.Sounds.sfx,i.partial(i.invoke,i,"setVolume",r));localStorage.volume_sfx=r});v(l.SHOW_MENU_GAME_SCREEN,w(s.MENU_GAME_SCREEN));v(l.SHOW_MENU_STORE_SCREEN,w(s.MENU_STORE_SCREEN));v(l.SHOW_MENU_CONFIG_SCREEN,w(s.MENU_CONFIG_SCREEN));v(l.SHOW_CREDITS,w(s.CREDITS_SCREEN));v(l.SHOW_TUTORIAL,w(s.TUTORIAL_SCREEN));v(l.SHOW_PLAYING_CONFIG,w(s.PLAYING_CONFIG));v(l.SHOW_MENU,w(s.MENU_SCREEN));v(l.SHOW_PREVIOUS,function e(){E(c.prev_state)});v(l.SET_SKIN,function t(i){n.set("selected_skin",i.node.value);localStorage.setItem("skin",i.node.value);ga("send",{hitType:"event",eventCategory:"button",eventAction:"use_skin_button",eventLabel:i.node.value});N(e.PlayerTypes.PLAYER)});v(l.PLAYER_LOGIN,function t(){ga("send",{hitType:"event",eventCategory:"button",eventAction:"play_button",eventLabel:"mouse_click"});N(e.PlayerTypes.PLAYER)});r.HIDE_OWN_TRAIL=JSON.parse(localStorage.hide_own_trail||"false")?true:false;r.X_AXIS_MULT=JSON.parse(localStorage.flip_x||"false")?-1:1;r.Y_AXIS_MULT=JSON.parse(localStorage.flip_y||"false")?-1:1;v(l.TOGGLE_Y_AXIS,t("y"));v(l.TOGGLE_X_AXIS,t("x"));function t(e){return function t(i){var n="flip_"+e.toLowerCase();var o=e.toUpperCase()+"_AXIS_MULT";if(i.node.checked){r[o]=-1;c[n]=true}else{r[o]=1;c[n]=false}localStorage[n]=c[n]}}v(l.PAGE_RELOAD,location.reload.bind(location));v(l.PLAYER_RESPAWN,function e(){if(window.respawnPlayer){ga("send",{hitType:"event",eventCategory:"button",eventAction:"respawn_button"});b()}});v(l.PLAYER_LOGIN_KEYPRESS,function t(i){var r=i.original.which||i.original.keyCode;var n=13;if(r===n){if(window.startGame){ga("send",{hitType:"event",eventCategory:"button",eventAction:"play_button",eventLabel:"enter_key"});N(e.PlayerTypes.PLAYER)}}});if(isMobile.any){r.STEERING=r.STEERING_METHODS.MOUSE_DRAG}if(r.AUTO_PLAY){n.fire(l.PLAYER_LOGIN)}}function R(){return i.throttle(n.update.bind(n),1e3)}function T(){var e=document.querySelector('script[type="text/ractive"]').innerHTML==="";if(e){var t=document.querySelectorAll('script[type="text/ractive"], script[type^=x-shader]');Promise.all(i.map(t,O)).then(S)}else{S()}}function O(e){return fetch(e.src).then(P).then(L(e))}function P(e){return e.text()}function L(e){return function t(i){e.innerHTML=i}}T();return u}();var e=e||{};e.Game={};var v;var y;var g;var A;var S=new THREE.Raycaster;if(r.FOG_ENABLED){S.far=r.FOG_FAR}var w;var I;var R=new THREE.Vector3;var T=false;var O=false;var P;var L=new e.Model;e.Game.players={};e.Game.player_meshes=[];e.Game.fullscreen=function e(){var t=document.body;if(t.requestFullscreen){t.requestFullscreen()}else if(t.msRequestFullscreen){t.msRequestFullscreen()}else if(t.mozRequestFullScreen){t.mozRequestFullScreen()}else if(t.webkitRequestFullscreen){t.webkitRequestFullscreen()}};function N(t){var n,o;try{n=new THREE.WebGLRenderer;o=i.chain(r.REQUIRED_WEBGL_EXTENSIONS).map(n.extensions.get).some(i.isNull).value();n=undefined;if(o){throw new Error("missing WebGL extensions")}}catch(t){console.error("Failed to init game.  Possible WebGL failure.  Original error below.");console.error(t.message);e.UI.state(e.UI.STATES.GAME_INIT_ERROR);return}if(isMobile.any){e.Game.fullscreen()}if(r.MUSIC_ENABLED){e.Sounds.music.background.play()}e.UI.state(e.UI.STATES.PLAYING);w=t;var s=localStorage.player_name=a.filterName(e.UI.engine.get("player_name"));var l=localStorage.alpha_key=e.UI.engine.get("alpha_key");var c=localStorage.getItem("skin")||"default";var u=a.getRandomIntInclusive(0,r.COLORS.length-1);var p=r.COLORS[u];document.querySelector("meta[name=theme-color]").content=p;console.log("Player color",p);e.UI.engine.set("player_color",u);e.UI.engine.set("player_size",r.PLAYER_GET_SCORE(r.INITIAL_PLAYER_RADIUS));setTimeout(ae,15e3);_e(w,s,u,c,l)}function b(){console.log("Respawning player: ",I.getPlayerId());e.UI.state(e.UI.STATES.PLAYING);ye()}function C(){var t=i.after(4,function(){y.classList.add("active")});try{n();a()}catch(t){console.error("Failed to init game.  Possible WebGL failure.  Original error below.");e.UI.state(e.UI.STATES.GAME_INIT_ERROR);throw t}function n(){y=document.getElementById("render-canvas");v=new THREE.Scene;if(r.FOG_ENABLED){v.fog=new THREE.Fog(r.FOG_COLOR,r.FOG_NEAR,r.FOG_FAR)}e.Game.renderer=new THREE.WebGLRenderer({antialias:true,canvas:y});e.Game.renderer.setClearColor(r.FOG_COLOR);e.Game.renderer.setPixelRatio(window.devicePixelRatio);e.Game.renderer.setSize(window.innerWidth,window.innerHeight);g=new THREE.PerspectiveCamera(r.INITIAL_FOV,window.innerWidth/window.innerHeight,1,r.WORLD_HYPOTENUSE+100);g.position.set(0,0,0);P=new se(L,g.position,v);P.drawFood(v);P.hideFoodMultiple(L.food_respawning_indexes);M();var t=[];var i;for(var n=0;n<6;n++){i=(new THREE.TextureLoader).load("textures/skybox_grid_black.png");i.wrapS=i.wrapT=THREE.MirroredRepeatWrapping;i.repeat.set(r.WALL_GRID_SEGMENTS,r.WALL_GRID_SEGMENTS);t.push(new THREE.MeshBasicMaterial({map:i}));t[n].side=THREE.DoubleSide;t[n].transparent=true;t[n].alphaTest=.5;t[n].map.magFilter=THREE.NearestFilter;t[n].map.minFilter=THREE.LinearFilter}var a=new THREE.MeshFaceMaterial(t);var s=new THREE.BoxGeometry(L.worldSize.x,L.worldSize.y,L.worldSize.z,1,1,1);var l=new THREE.Mesh(s,a);l.renderOrder=-10;v.add(l);var c=new THREE.AmbientLight(2236962);v.add(c);window.addEventListener("resize",o,false)}function o(){g.aspect=window.innerWidth/window.innerHeight;g.updateProjectionMatrix();e.Game.renderer.setSize(window.innerWidth,window.innerHeight)}function a(){requestAnimationFrame(a);var t=e.UI.state();if(t.indexOf("menu")===0||t===e.UI.STATES.CREDITS_SCREEN){g.rotation.y-=r.TITLE_CAMERA_SPIN_SPEED*e.LagScale.get()}var i;F();if(T&&!I.isDead){i=I.view.mainSphere.position;I.resetVelocity();Z();e.LagScale.update();I.update(v,g,A,e.LagScale.get());Pe();Re(I.model.sphere.id,I.view.mainSphere.position);P.checkFoodCaptures(I,V);A.update();S.set(I.view.mainSphere.position,g.getWorldDirection().normalize());k();G()}else if(e.UI.state().indexOf("menu")===0){i=g.position}else if(I&&I.isDead){i=I.model.sphere.position}else{i={x:0,y:0,z:0}}R.copy(i);P.update(i);e.UI.update();s()}function s(){e.Game.renderer.render(v,g);t()}}function D(){I.initView(v);g=new THREE.PerspectiveCamera(r.INITIAL_FOV,window.innerWidth/window.innerHeight,1,r.WORLD_HYPOTENUSE+100);if(r.STEERING.NAME==="FOLLOW"){A=new THREE.TrackballControls(g,e.Game.renderer.domElement);A.staticMoving=true;A.noZoom=false;A.noPan=true;A.dynamicDampingFactor=0;A.rotateSpeed=r.STEERING.SPEED;A.target=I.view.mainSphere.position}else if(r.STEERING.NAME==="DRAG"){A=new THREE.FollowOrbitControls(g,e.Game.renderer.domElement);A.enableDamping=true;A.dampingFactor=.25;A.enableZoom=false;A.target=I.view.mainSphere}A.minDistance=r.INITIAL_CAMERA_DISTANCE;A.maxDistance=r.INITIAL_CAMERA_DISTANCE;g.position.copy(I.model.sphere.position.clone().multiplyScalar(1.2));I.setCameraControls(A);I.view.adjustCamera(I.radius());R.copy(I.view.mainSphere.position)}function M(){L.players.forEach(function t(i){if(i.type!=e.PlayerTypes.SPECTATOR){var r=i.id;if(!I||r!==I.getPlayerId()){e.Game.players[r]=new e.PlayerController(i,v);e.Game.players[r].setAlpha(1)}}})}function F(){L.actors.forEach(function t(i){if(i.type===e.ActorTypes.PLAYER_SPHERE){if(!I||i.id!==I.getSphereId()){var r=e.Game.players[i.playerId];if(r&&r.view){r.updatePosition(i.position);r.updateScale(i.scale);r.updateDrain(i.drain_target_id)}}else{I.updateScale(i.scale);I.updateDrain(i.drain_target_id)}}})}F.runningActorUpdateGap=r.TICK_FAST_INTERVAL;function U(){var t=I.getScore();if(t!=I.lastScore){e.UI.engine.set("player_size",t);I.lastScore=t}}var k=i.throttle(U,70);function x(){var t=S.intersectObjects(e.Game.player_meshes);if(t&&t.length>0){var i=t[0].object;if(i&&i.player_id>0){var r=i.player_id===I.model.id;if(!r){var n=e.Game.players[i.player_id];if(n){var o=I.getTargetLock()!==i.player_id;var a=n.getScore();var s={name:n.model.name,score:a,color:n.model.sphere.color};if(o){I.setTargetLock(i.player_id);e.UI.engine.set("target",s);n.lastScore=a;clearTimeout(e.UI.target_clear_timeout_id)}else if(a!=n.lastScore){e.UI.engine.set("target",{name:n.model.name,score:a,color:n.model.sphere.color});n.lastScore=a}}}}}else if(I.getTargetLock()){I.setTargetLock(0);e.UI.target_clear_timeout_id=setTimeout(e.UI.clearTarget,4e3);console.log("clearing target lock")}}var G=i.throttle(x,100);function V(e){I.queueFoodCapture(e);P.hideFood(e)}window.addEventListener("keydown",W);window.addEventListener("keyup",z);window.addEventListener("mousedown",X);window.addEventListener("mouseup",j);window.onload=function e(){me()};var B={};var Y={87:"w",83:"s",65:"a",68:"d",32:"space",16:"shift"};var H=Object.keys(Y);function W(e){var t;var i;if(!T||I.isDead)return;t=H.indexOf(e.keyCode+"")!==-1;if(t){i=B[Y[e.keyCode]];if(!i){K(Y[e.keyCode])}B[Y[e.keyCode]]=true}}function z(e){if(!T||I.isDead)return;var t=H.indexOf(e.keyCode+"")!==-1;if(t){Q(Y[e.keyCode]);B[Y[e.keyCode]]=false}}function X(e){if(!T||I.isDead)return;if(e.button===0&&r.AUTO_RUN_ENABLED&&!isMobile.any){if(I.isSpeedBoostReady()){Te()}}}function j(e){if(!T||I.isDead)return;if(e.button===0&&r.AUTO_RUN_ENABLED&&!isMobile.any){I.speedBoostStop();Oe()}}function Z(){for(var e in B){if(B[e]){q(e)}}}function q(e){if(e==="w"&&!r.AUTO_RUN_ENABLED){I.moveForward(g)}else if(e==="s"){I.moveBackward(g)}}function K(e){if(e==="w"&&r.AUTO_RUN_ENABLED){if(I.isSpeedBoostReady()){Te()}}}function Q(e){if(e==="w"&&r.AUTO_RUN_ENABLED){if(I.isSpeedBoostActive()){I.speedBoostStop();Oe()}}}function J(t,i){var r=e.Game.players[t];setTimeout(function i(){L.removePlayer(t);if(r){if(r.view){r.removeView()}delete e.Game.players[t]}console.log("Removed player: ",t)},i)}function ee(t){if(!T)return;t.leaders.forEach(function t(i){var r=e.Game.players[i.player_id];i.name=r.model.name;i.color=r.model.sphere.color});e.UI.engine.set("leaders",t.leaders);e.UI.data.leaders=t.leaders;if(P&&P.isInitialized()){for(var i=0,r=t.fr.length;i<r;++i){P.showFood(t.fr[i])}for(i=0,r=t.fc.length;i<r;++i){P.hideFood(t.fc[i])}}e.UI.engine.set("server_message",t.sm);e.expireLocks()}function te(t){var i=e.Sounds.sfx.player_capture;var r=e.Game.players[t];var n=0;if(r){e.Sounds.playFromPos(i,I.view.mainSphere,r.model.sphere.position);r.handleCapture();n=r.getWindDownTime();e.UI.engine.set("capture_message","You captured "+r.model.name);setTimeout(function t(){e.UI.engine.set("capture_message","")},5e3)}J(t,n)}function ie(t){var i=e.Sounds.sfx.player_capture;var r=e.Game.players[t];var n=0;if(r){e.Sounds.playFromPos(i,I.view.mainSphere,r.model.sphere.position);r.handleCapture();n=r.getWindDownTime()}console.log("Player died:  ",t);J(t,n)}function re(t){var i=t.attacking_player_id;console.log("YOU DIED! You were alive for "+t.time_alive+" seconds. Killed by: ",i);oe();var n=L.getPlayerById(i);n.score=r.PLAYER_GET_SCORE(n.sphere.scale);var o={drainAmount:t.drain_ammount,foodCaptures:t.food_captures,playerCaptures:t.player_captures,score:t.score};e.UI.engine.set("attacker",n);e.UI.engine.set("player",o);e.UI.state(e.UI.STATES.RESPAWN_SCREEN)}function ne(t){e.UI.state(e.UI.STATES.KICKED_SCREEN);e.UI.engine.set("kicked_message",t)}function oe(){I.beingCaptured=false;I.isDead=true;Le();B={}}function ae(){if(T&&!I.isDead){var e=I.model.ping_metric.last;var t=I.model.fps_metric.last;if(e>0){ga("send",{hitType:"timing",timingCategory:"Ping",timingVar:"ping",timingValue:e,timingLabel:linodeNearLocation()})}if(t>0){ga("send",{hitType:"timing",timingCategory:"FPS",timingVar:"fps",timingValue:t})}}}var e=e||{};e.PlayerView=function t(i,n,o){var a=this;this.model=i;this.scene=n;this.is_current_player=o||false;
this.playerColor=r.COLORS[i.sphere.color];this.skinName=i.sphere.skin;this.clock=new THREE.Clock;this.trail={initialized:false};this.cameraMinDistance=r.GET_CAMERA_MIN_DISTANCE(i.sphere.scale);this.skin=e.PlayerSkins[this.skinName||"default"](this);this.geometry=new THREE.SphereGeometry(1,this.skin.geometry.polycount_w||r.PLAYER_SPHERE_POLYCOUNT,this.skin.geometry.polycount_h||r.PLAYER_SPHERE_POLYCOUNT);R.copy(i.sphere.position);this.material=new THREE.ShaderMaterial(this.skin.material);if(r.FOOD_ALPHA_ENABLED){this.material.depthWrite=true}this.mainSphere=new THREE.Mesh(this.geometry,this.material);this.mainSphere.position.copy(i.sphere.position);this.drainView=new e.DrainView(this,n);this.setScale(i.sphere.scale);this.mainSphere.player_id=this.model.id;e.Game.player_meshes.push(this.mainSphere);this.initCaptureParticles();n.add(this.mainSphere);setTimeout(function(){a.initTrails()},250)};e.PlayerView.prototype.initTrails=function t(){var i=this;switch(this.skin.trail.type){case"line":this.initLineTrails();break;case"particle":this.initParticleTrails();break}e.UI.on(e.UI.ACTIONS.TOGGLE_OWN_TRAIL,function(t){if(i.is_current_player){if(t.node.checked){i.hideTrails();e.UI.setAndSave("hide_own_trail",true)}else{i.showTrails();e.UI.setAndSave("hide_own_trail",false)}}});if(r.HIDE_OWN_TRAIL&&this.is_current_player){i.hideTrails()}};e.PlayerView.prototype.initCaptureParticles=function e(){this.capture={};this.capture.group=new SPE.Group(this.skin.capture.group);this.capture.emitter=new SPE.Emitter(this.skin.capture.emitter);this.capture.emitter.disable();this.capture.group.addEmitter(this.capture.emitter);this.capture.group.mesh.frustumCulled=false;this.capture.group.mesh.renderOrder=-1;this.capture.active=false;this.scene.add(this.capture.group.mesh)};e.PlayerView.prototype.initParticleTrails=function e(){this.trail.group=new SPE.Group(this.skin.trail.group);this.trail.emitter=new SPE.Emitter(this.skin.trail.emitter);this.trail.group.mesh.renderOrder=-2;this.trail.group.mesh.frustumCulled=false;this.trail.group.addEmitter(this.trail.emitter);this.trail.visible=1;this.scene.add(this.trail.group.mesh);this.trail.initialized=true};e.PlayerView.prototype.initLineTrails=function e(){this.trail.material=new THREE.MeshLineMaterial({useMap:0,color:this.skin.trail.color,opacity:1,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),sizeAttenuation:1,lineWidth:this.skin.trail.customScale*r.TRAIL_LINE_WIDTH,near:g.near,far:g.far,depthTest:true,blending:THREE.AdditiveBlending,transparent:false,side:THREE.DoubleSide,visibility:1});this.trail.origins=[];this.trail.geometries=[];this.trail.lines=[];this.trail.meshes=[];for(var t=0;t<this.skin.trail.origins.length;++t){this.trail.origins[t]=this.mainSphere.localToWorld(this.skin.trail.origins[t].clone());this.trail.geometries[t]=new THREE.Geometry;for(var i=0;i<r.TRAIL_LINE_LENGTH;++i){this.trail.geometries[t].vertices.push(this.trail.origins[t])}this.trail.lines[t]=new THREE.MeshLine;this.trail.lines[t].setGeometry(this.trail.geometries[t],this.skin.trail.lineWidth);this.trail.meshes[t]=new THREE.Mesh(this.trail.lines[t].geometry,this.trail.material);this.trail.meshes[t].frustumCulled=false;this.scene.add(this.trail.meshes[t])}this.trail.initialized=true};e.PlayerView.prototype.hideTrails=function e(){if(!this.trail.initialized)return;switch(this.skin.trail.type){case"line":this.hideLineTrails();break;case"particle":this.hideParticleTrails();break}};e.PlayerView.prototype.showTrails=function e(){if(!this.trail.initialized)return;switch(this.skin.trail.type){case"line":this.showLineTrails();break;case"particle":this.showParticleTrails();break}};e.PlayerView.prototype.hideLineTrails=function e(){this.trail.material.transparent=true;this.trail.material.depthTest=false;this.trail.material.visible=false;this.trail.material.uniforms.opacity.value=0;this.trail.material.uniforms.visibility.value=0};e.PlayerView.prototype.hideParticleTrails=function e(){this.trail.visible=0};e.PlayerView.prototype.showLineTrails=function e(){this.trail.material.transparent=false;this.trail.material.depthTest=true;this.trail.material.visible=true;this.trail.material.uniforms.opacity.value=1;this.trail.material.uniforms.visibility.value=1};e.PlayerView.prototype.showParticleTrails=function e(){this.trail.visible=1};e.PlayerView.prototype.updateTrails=function e(){switch(this.skin.trail.type){case"line":this.updateLineTrails();break;case"particle":this.updateParticleTrails();break}};e.PlayerView.prototype.updateParticleTrails=function e(){if(!this.trail.initialized)return;var t=this.mainSphere.position.clone();this.trail.emitter.position._value.x=t.x;this.trail.emitter.position._value.y=t.y;this.trail.emitter.position._value.z=t.z;var i=this.mainSphere.scale.x*(this.skin.trail.customScale||1);this.trail.emitter.position._spreadClamp.setX(i);this.trail.emitter.position._spread.setX(i);this.trail.emitter.position._radius=i;this.trail.emitter.size._value=[i/3,i*2/6,i/9,0];var r=this.model.abilities.speed_boost.isActive();if(r){this.trail.emitter.activeMultiplier=1*this.trail.visible}else{this.trail.emitter.activeMultiplier=.1*this.trail.visible}this.trail.emitter.updateFlags.position=true;this.trail.emitter.updateFlags.velocity=true;this.trail.emitter.updateFlags.size=true;this.trail.group.tick(this.clock.getDelta())};e.PlayerView.prototype.updateLineTrails=function e(){if(!this.trail.initialized)return;this.trail.material.uniforms.lineWidth.value=this.skin.trail.customScale*r.TRAIL_LINE_WIDTH*(1+this.mainSphere.scale.x/10);for(var t=0;t<this.skin.trail.origins.length;++t){this.trail.lines[t].advance(this.mainSphere.localToWorld(this.skin.trail.origins[t].clone()))}};e.PlayerView.prototype.grow=function e(t){this.mainSphere.scale.addScalar(t);this.mainSphere.scale.clampScalar(1,r.MAX_PLAYER_RADIUS)};e.PlayerView.prototype.handleCapture=function e(){this.capture.active=true;this.mainSphere.visible=false;this.drainView.mesh.visible=false;this.removeTrail();var t=this.mainSphere.position.clone();this.capture.emitter.position.value=t;var i=this.mainSphere.scale.x*(this.skin.capture.customScale||1);this.capture.emitter.position.radius=i;this.capture.emitter.size.value=[i/3,i*2/6,i/9,0];this.capture.emitter.enable()};e.PlayerView.prototype.update=function e(t){this.setScale(t*.1+this.mainSphere.scale.x*.9);this.updateTrails();if(this.is_current_player||this.skin.behavior.faceCamera){this.updateDirection()}if(this.capture.active){this.capture.group.tick(this.clock.getDelta())}};e.PlayerView.prototype.updateDirection=function e(){this.mainSphere.lookAt(g.position);this.mainSphere.up.copy(g.up)};e.PlayerView.prototype.updateDrain=function e(t){this.drainView.update(t)};e.PlayerView.prototype.setAlpha=function e(t){this.material.transparent=!t};e.PlayerView.prototype.updatePosition=function e(t){this.mainSphere.position.lerp(t,r.PLAYER_MOVE_LERP_WEIGHT)};e.PlayerView.prototype.removeTrail=function e(){if(this.trail.initialized){switch(this.skin.trail.type){case"line":this.trail.origins=[];this.trail.geometries=[];this.trail.lines=[];this.trail.meshes.forEach(this.scene.remove.bind(v));break;case"particle":if(this.trail.emitter.group)this.trail.emitter.remove();this.trail.group.dispose();this.scene.remove(this.trail.group.mesh);break}this.trail.initialized=false}};e.PlayerView.prototype.removeCaptureParticles=function e(){this.capture.emitter.remove();this.capture.group.dispose();this.scene.remove(this.capture.group.mesh)};e.PlayerView.prototype.remove=function t(){this.removeTrail();this.removeCaptureParticles();this.drainView.dispose();this.scene.remove(this.mainSphere);for(var i=0;i<e.Game.player_meshes.length;i++){var r=e.Game.player_meshes[i];if(r&&r.player_id===this.model.id){console.log("Removing mesh for player: ",this.model.id);e.Game.player_meshes.splice(i,1)}}};e.PlayerView.prototype.getCaptureEmitterLifetime=function e(){return Math.floor((this.capture.emitter.maxAge.value+this.capture.emitter.maxAge.spread+this.capture.emitter.duration+.1)*1e3)};e.PlayerView.prototype.setScale=function e(t){this.mainSphere.scale.set(t,t,t);this.mainSphere.scale.clampScalar(1,r.MAX_PLAYER_RADIUS)};e.PlayerView.prototype.setCameraControls=function e(t){this.camera_controls=t};e.PlayerView.prototype.adjustCamera=function e(t){var i=r.GET_CAMERA_MIN_DISTANCE(t);this.camera_controls.minDistance=a.lerp(this.camera_controls.minDistance,this.cameraMinDistance,.03);if(i!=this.cameraMinDistance){if(this.shouldChangeMinDist(i)){console.log("New camera minDistance: ",i);this.cameraMinDistance=i}}};e.PlayerView.prototype.shouldChangeMinDist=function e(t){var i=this.cameraMinDistance;var n=this.model.sphere.scale;var o=r.CAMERA_ZOOM_STEPS[Math.floor(i)];if(i>t){if(o.min-n>=r.CAMERA_ZOOM_STEP_BUFFER){return true}}else if(i<t){if(n-o.max>=r.CAMERA_ZOOM_STEP_BUFFER){return true}}return false};var e=e||{};e.PlayerController=function t(i,r,n){this.model=new e.Player(i.id,i.name,i.sphere.color,i.type,i.sphere.position,i.sphere.scale,i.sphere.velocity,i.sphere.skin);this.isDead=false;this.is_current_player=n||false;this.lastScore=0;this.move_forward_v=new THREE.Vector3;this.move_backward_v=new THREE.Vector3;this.food_capture_queue=[];if(r){this.initView(r)}this.model.abilities.speed_boost.on("activate",function(){e.Sounds.sfx.woosh.play()});this.model.abilities.speed_boost.on("deactivate",function(){e.Sounds.sfx.woosh.stop()})};e.PlayerController.prototype.queueFoodCapture=function e(t){this.food_capture_queue.push({fi:t,radius:this.radius()})};e.PlayerController.prototype.getPlayerId=function e(){return this.model.id};e.PlayerController.prototype.getSphereId=function e(){return this.model.sphere.id};e.PlayerController.prototype.getPosition=function e(){return this.view.mainSphere.position};e.PlayerController.prototype.getSpeed=function e(){return this.model.getSpeed()};e.PlayerController.prototype.getScore=function e(){return this.model.getScore()};e.PlayerController.prototype.setAlpha=function e(t){if(this.view){this.view.setAlpha(t)}};e.PlayerController.prototype.initView=function t(i){this.view=new e.PlayerView(this.model,i,this.is_current_player,this.skinName)};e.PlayerController.prototype.removeView=function e(){this.view.remove();this.view=undefined};e.PlayerController.prototype.getWindDownTime=function e(){var t=0;if(this.view){t=this.view.getCaptureEmitterLifetime()}return t};e.PlayerController.prototype.grow=function e(t){this.model.sphere.scale+=t};e.PlayerController.prototype.animatedGrow=function e(t,i){this._animated_grow_frames=i;this._animated_grow_amount=t/i};e.PlayerController.prototype.refreshSphereModel=function e(){if(!this.view){return}this.model.sphere.position.copy(this.view.mainSphere.position)};e.PlayerController.prototype.handleCapture=function e(){this.view.handleCapture()};e.PlayerController.prototype.updateScale=function e(t){this.setScale(t);this.view.update(t)};e.PlayerController.prototype.updateDrain=function e(t){this.model.sphere.drain_target_id=t;this.view.updateDrain(t)};e.PlayerController.prototype.updatePosition=function e(t){this.model.sphere.position.copy(t);this.view.updatePosition(t)};e.PlayerController.prototype.radius=function e(){return this.model.sphere.scale};e.PlayerController.prototype.setScale=function e(t){this.model.sphere.scale=t};e.PlayerController.prototype.update=function e(t,i,n,o){this.model.abilities.speed_boost.update();if(r.AUTO_RUN_ENABLED){this.moveForward(i)}this.applyVelocity(o,n);this.view.adjustCamera(this.radius());this.view.updateDrain(this.model.sphere.drain_target_id);if(this._animated_grow_frames>0){this.view.grow(this._animated_grow_amount);this._animated_grow_frames--}};e.PlayerController.prototype.applyVelocity=function e(t,i){this.model.sphere.velocity.sub(i.velocityRequest);this.model.sphere.velocity.normalize();this.model.sphere.velocity.multiplyScalar(I.getSpeed()*t);this.view.mainSphere.position.sub(a.adjustVelocityWallHit(this.view.mainSphere.position,0,this.model.sphere.velocity,L.worldSize));this.model.sphere.position.copy(this.view.mainSphere.position);this.addRecentPosition();i.velocityRequest.set(0,0,0)};e.PlayerController.prototype.addRecentPosition=function e(){var t={x:this.view.mainSphere.position.x,y:this.view.mainSphere.position.y,z:this.view.mainSphere.position.z};var i=Date.now()-this.model.createdTime;this.model.sphere.recentPositions.push({position:t,radius:this.radius(),time:i});if(this.model.sphere.recentPositions.length>r.PLAYER_POSITIONS_WINDOW){this.model.sphere.recentPositions.shift()}};e.PlayerController.prototype.resetVelocity=function e(){this.model.sphere.velocity.set(0,0,0)};e.PlayerController.prototype.moveForward=function e(t){var i=this.move_forward_v;var r=this.view.mainSphere;i.copy(r.position);i.sub(t.position);i.multiplyScalar(-1);i.normalize();i.multiplyScalar(this.getSpeed());this.model.sphere.velocity.add(i)};e.PlayerController.prototype.moveBackward=function e(t){var i=this.move_backward_v;var r=this.view.mainSphere;i.copy(r.position);i.sub(t.position);i.normalize();i.multiplyScalar(this.getSpeed());this.model.sphere.velocity.add(i)};e.PlayerController.prototype.setCameraControls=function e(t){this.view.setCameraControls(t)};e.PlayerController.prototype.speedBoostStart=function e(){this.model.abilities.speed_boost.activate()};e.PlayerController.prototype.speedBoostStop=function e(){this.model.abilities.speed_boost.deactivate()};e.PlayerController.prototype.isSpeedBoostActive=function e(){return this.model.abilities.speed_boost.isActive()};e.PlayerController.prototype.isSpeedBoostReady=function e(){return this.model.abilities.speed_boost.isReady()};e.PlayerController.prototype.setSpeedBoostActive=function e(t){this.model.abilities.speed_boost.active=t};e.PlayerController.prototype.setTargetLock=function e(t){this.targeting_player_id=t};e.PlayerController.prototype.getTargetLock=function e(){return this.targeting_player_id};var se=function t(n,o){this.model=n;this.view=new le;this.fogCenterPosition=new THREE.Vector3;this.fogCenterPosition.copy(o);this.octree=new THREE.Octree({undeferred:true,depthMax:Infinity,objectsThreshold:8,overlapPct:.15});this.drawFood=function e(t){this.view.drawFood(t,this.model.food,this.model.foodCount,this.fogCenterPosition,this.octree)};this.update=function e(t){this.fogCenterPosition.copy(t);this.view.update()};this.isInitialized=function e(){return this.view.initialized};this.aliveFood=function e(t){return this.view.aliveFood(t)};this.hideFood=function e(t){this.view.hideFood(t)};this.showFood=function e(t){this.view.showFood(t)};this.hideFoodMultiple=function e(t){this.view.hideFoodMultiple(t)};this.checkFoodCaptures=function t(n,o){var a,s;var l=0;var c=n.view.mainSphere;var u=n.radius();var p=this.octree.search(c.position,u+25);for(a=0,s=p.length;a<s;a++){var h=p[a];var d=p[a].object.fi;if(this.aliveFood(d)){l=h.position.distanceTo(c.position);if(l<=u+r.FOOD_CAPTURE_ASSIST){o(d);var f=i.sample(e.Sounds.sfx.food_capture);e.Sounds.playFromPos(f,I.view.mainSphere,h.position.clone())}}}}};var le=function t(){this.initialized=false;this.drawFood=function e(t,i,n,o,s){this.translate=new Float32Array(n*3);this.colors=new Float32Array(n*3);this.respawning=new Float32Array(n);this.geometry=new THREE.InstancedBufferGeometry;this.geometry.copy(new THREE.PlaneBufferGeometry(2,2));var l=a.getFoodCrayon(r.FOOD_COLORING_TYPE);var c=this.translate;var u=this.colors;var p=this.respawning;var h,d,f,m,_,E;var v=0;for(var y=0,g=n;y<g;y++){h=i[v];d=i[v+1];f=i[v+2];var A=l(h,d,f);m=A.r;_=A.g;E=A.b;p[y]=0;c[v]=h;c[v+1]=d;c[v+2]=f;u[v]=m;u[v+1]=_;u[v+2]=E;var S={x:h,y:d,z:f,radius:1,fi:y};s.add(S);v+=3}this.geometry.addAttribute("translate",new THREE.InstancedBufferAttribute(c,3,1));this.geometry.addAttribute("respawning",new THREE.InstancedBufferAttribute(p,1,1));this.geometry.addAttribute("color",new THREE.InstancedBufferAttribute(u,3,1));this.material=new THREE.RawShaderMaterial({uniforms:{map:{type:"t",value:(new THREE.TextureLoader).load("textures/soft-square.png")},mainSpherePos:{type:"v3",value:o},FOG_FAR:{type:"f",value:r.FOG_FAR},FOG_ENABLED:{type:"f",value:~~r.FOG_ENABLED},ALPHA_ENABLED:{type:"f",value:~~r.FOOD_ALPHA_ENABLED},FOOD_RESPAWN_ANIM_DURATION:{type:"f",value:r.FOOD_RESPAWN_ANIM_DURATION}},vertexShader:document.getElementById("food-vertex-shader").textContent,fragmentShader:document.getElementById("food-frag-shader").textContent,depthTest:true,depthWrite:true});this.mesh=new THREE.Mesh(this.geometry,this.material);this.mesh.frustumCulled=false;t.add(this.mesh);this.initialized=true};this.update=function t(){var i=this.respawning;var n=i.length;var o;var a=r.FOOD_RESPAWN_ANIM_DURATION;var s=e.LagScale.get;while(n--){o=i[n];if(o<=a){i[n]=Math.max(0,o-Math.round(s()))}}this.mesh.geometry.attributes.respawning.needsUpdate=true};this.aliveFood=function e(t){return this.respawning[t]===0};this.hideFood=function e(t){this.respawning[t]=r.FOOD_RESPAWN_ANIM_DURATION+1};this.showFood=function e(t){this.respawning[t]=r.FOOD_RESPAWN_ANIM_DURATION};this.hideFoodMultiple=function e(t){i.each(t,this.hideFood.bind(this))}};var e=e||{};e.DrainView=function e(t,i){this.MORPH_INDEX_STRETCH=0;this.MORPH_INDEX_DRAINER_TAPER=1;this.MORPH_INDEX_DRAINEE_TAPER=2;this.MORPH_INDEX_PINCH=3;this.scene=i;this.playerView=t;this.time=.1;this.initialCylinderLength=r.DRAIN_MAX_DISTANCE;this.initialCylinderRadius=r.MAX_PLAYER_RADIUS/2;this.geometry=new THREE.CylinderGeometry(this.initialCylinderRadius,this.initialCylinderRadius,this.initialCylinderLength,16,12,true);this.geometry.rotateX(Math.PI/2);this.createStretch();this.createDrainerTaper();this.createDraineeTaper();this.createPinch(this.initialCylinderLength);this.material=new THREE.ShaderMaterial({uniforms:{time:{type:"f",value:this.time},power:{type:"f",value:0},erColor:{type:"c",value:new THREE.Color(this.playerView.playerColor)},eeColor:{type:"c",value:0},len:{type:"f",value:0},mainSpherePos:{type:"v3",value:R},pos:{type:"v3",value:new THREE.Vector3},FOG_FAR:{type:"f",value:r.FOG_FAR},FOG_ENABLED:{type:"f",value:~~r.FOG_ENABLED}},vertexShader:document.getElementById("drain-vertex-shader").textContent,fragmentShader:document.getElementById("drain-frag-shader").textContent,side:THREE.DoubleSide,transparent:true,opacity:.8,depthFunc:THREE.LessDepth,depthTest:false,depthWrite:true,blending:THREE.AdditiveBlending,alphaTest:1,morphTargets:true});this.mesh=new THREE.Mesh(this.geometry,this.material);this.mesh.renderOrder=10;this.mesh.morphTargetInfluences[this.MORPH_INDEX_STRETCH]=0;this.mesh.morphTargetInfluences[this.MORPH_INDEX_DRAINER_TAPER]=0;this.mesh.morphTargetInfluences[this.MORPH_INDEX_DRAINEE_TAPER]=0;this.mesh.morphTargetInfluences[this.MORPH_INDEX_PINCH]=.065;this.hide();i.add(this.mesh)};e.DrainView.prototype.pinch=function e(t,i){return Math.max(0,1-Math.pow(t-i/2,2)/Math.pow(i/2,2))};e.DrainView.prototype.update=function t(i){if(i===0){this.hide();return}var r=e.Game.players[i];if(!r)return;var n=this.playerView.mainSphere.position;var o=r.view.mainSphere.position;var a=this.playerView.mainSphere.scale.x;var s=r.view.mainSphere.scale.x;var l=n.distanceTo(o)-a-s;this.material.uniforms.pos.value.copy(this.mesh.position);if(r&&n&&o&&a&&s){this.updateVisibility(l)}else{this.hide()}if(this.isVisible()){this.updateStretch(l);this.updateUniforms(r,l);this.updateDrainerTaper(this.playerView.mainSphere.scale.x);this.updateDraineeTaper(r.model.sphere.scale);this.updatePosition(n,o,a,s)}};e.DrainView.prototype.hide=function e(){if(this.mesh.material.visible){this.mesh.material.visible=false}};e.DrainView.prototype.show=function e(){if(!this.mesh.material.visible){this.mesh.material.visible=true}};e.DrainView.prototype.isVisible=function e(){return this.material.visible};e.DrainView.prototype.updateVisibility=function e(t){if(t>0){this.show()}else{this.hide()}};e.DrainView.prototype.updatePosition=function e(t,i,r,n){var o=i.clone().sub(t).normalize().multiplyScalar(-n).add(t);var a=t.clone().sub(i).normalize().multiplyScalar(-r).add(i);this.mesh.position.copy(o.add(a).divideScalar(2));this.mesh.lookAt(t)};e.DrainView.prototype.updateUniforms=function t(i,n){this.time+=e.LagScale.get()/r.DRAIN_RADIO_FREQUENCY;this.material.uniforms.time.value=this.time;this.material.uniforms.eeColor.value=new THREE.Color(i.view.playerColor);this.material.uniforms.len.value=n;this.material.uniforms.power.value=1-n/r.DRAIN_MAX_DISTANCE};e.DrainView.prototype.createStretch=function e(){var t=this.createStretchVertices();this.geometry.morphTargets.push({name:"stretch",vertices:t})};e.DrainView.prototype.createStretchVertices=function e(){var t=[];for(var i=0;i<this.geometry.vertices.length;i++){t[i]=this.geometry.vertices[i].clone();t[i].z=0}return t};e.DrainView.prototype.updateStretch=function e(t){this.mesh.morphTargetInfluences[this.MORPH_INDEX_STRETCH]=1-t/r.DRAIN_MAX_DISTANCE};e.DrainView.prototype.updateTaper=function e(t,i){var n=.85-Math.pow(t/r.MAX_PLAYER_RADIUS,2)/2;this.mesh.morphTargetInfluences[i]=n};e.DrainView.prototype.createDrainerTaper=function e(){var t=this.createDrainerTaperVertices();this.geometry.morphTargets.push({name:"drainer_taper",vertices:t})};e.DrainView.prototype.createDrainerTaperVertices=function e(){var t=[];var i;for(var n=0;n<this.geometry.vertices.length;n++){t[n]=this.geometry.vertices[n].clone();i=1-(t[n].z+r.DRAIN_MAX_DISTANCE/2)/this.initialCylinderLength;t[n].x*=i;t[n].y*=i}return t};e.DrainView.prototype.updateDrainerTaper=function e(t){this.updateTaper(t,this.MORPH_INDEX_DRAINER_TAPER)};e.DrainView.prototype.createDraineeTaper=function e(){var t=this.createDraineeTaperVertices();this.geometry.morphTargets.push({name:"drainee_taper",vertices:t})};e.DrainView.prototype.createDraineeTaperVertices=function e(){var t=[];var i;for(var n=0;n<this.geometry.vertices.length;n++){t[n]=this.geometry.vertices[n].clone();i=(t[n].z+r.DRAIN_MAX_DISTANCE/2)/this.initialCylinderLength;t[n].x*=i;t[n].y*=i}return t};e.DrainView.prototype.updateDraineeTaper=function e(t){this.updateTaper(t,this.MORPH_INDEX_DRAINEE_TAPER)};e.DrainView.prototype.createPinch=function e(t){var i=this.createPinchVertices(t);this.geometry.morphTargets.push({name:"pinch",vertices:i})};e.DrainView.prototype.createPinchVertices=function e(t){var i=[];for(var r=0;r<this.geometry.vertices.length;r++){i[r]=this.geometry.vertices[r].clone();i[r].x*=-this.pinch(i[r].z+t/2,t);i[r].y*=-this.pinch(i[r].z+t/2,t)}return i};e.DrainView.prototype.dispose=function e(){this.scene.remove(this.mesh);this.geometry.dispose();this.material.dispose()};var ce;var ue;var pe=0;var he=0;var de="";var fe;function me(){var e=new URI("ws://"+r.BALANCER+":"+r.WS_PORT);ce=new WebSocket(e.toString());ce.binaryType="arraybuffer";ce.onopen=function e(){console.log("WebSocket connection established and ready.");Ee(ce)}}function _e(e,t,i,r,n){if(ce.readyState===WebSocket.OPEN){ce.send(JSON.stringify({op:"enter_game",type:e,name:t,color:i,skin:r,key:n}))}}function Ee(t){t.onmessage=function t(i){if(typeof i.data==="string"){var r=n(i.data);switch(r.op){case"welcome":s(r);break;case"game_setup":l();break;case"player_join":c(r);break;case"zor_pong":u();break;case"captured_player":d(r);break;case"player_died":m(r);break;case"kick":E(r);break;case"remove_player":y(r);break;case"speeding_warning":g();break;case"speed_boost_res":A(r);break;case"speed_boost_stop":S();break}}else{var v=a.readFirstByte(i.data);switch(v){case e.Schemas.ops.INIT_GAME:o(e.Schemas.initGameSchema.decode(i.data));break;case e.Schemas.ops.ACTOR_UPDATES:h(e.Schemas.actorUpdatesSchema.decode(i.data));break;case e.Schemas.ops.TICK_SLOW:_(e.Schemas.tickSlowSchema.decode(i.data));break;case e.Schemas.ops.YOU_DIED:f(e.Schemas.youDied.decode(i.data));break;case e.Schemas.ops.WELCOME:s(e.Schemas.welcomeSchema.decode(i.data));break;default:var w=new Float32Array(i.data);if(w[0]===e.Schemas.ops.CLIENT_POSITION_RAPID){p(w)}else{console.error("Error: Unknown binary op code: ",v)}}}};t.onclose=function e(t){if(t.code!=r.CLOSE_NO_RESTART){ve()}O=true;console.log("Connection closed:",t.code,t.reason)};t.onerror=function e(t){console.error("Websocket error occured",t)};function n(e){return JSON.parse(e)}function o(t){t.model.actors.forEach(function e(t){a.toVector3(t,"position");a.toVector3(t,"velocity")});de=t.NB_SRVID;i.assign(L,t.model);e.UI.on("init",C);console.log("Game initialzed")}function s(i){console.log("Welcome: ",i.player.name);I=new e.PlayerController(i.player,null,true);t.send(JSON.stringify({op:"player_ready"}))}function l(){e.Game.players[I.getPlayerId()]=I;L.addActor(I.model.sphere);D();T=true;Ae();console.log("Game started!")}function c(t){var i=t.player;if(I&&i.id===I.getPlayerId()){return}if(!e.Game.players[i.id]){e.Game.players[i.id]=new e.PlayerController(i,v);e.Game.players[i.id].setAlpha(1);a.toVector3(i.sphere,"position");a.toVector3(i.sphere,"velocity");L.players.push(i);L.addActor(i.sphere)}console.log("Player joined: ",i.id,i.name)}function u(){pe=Date.now()-ue;I.model.ping_metric.add(pe);console.log("Ping: "+pe+"ms, FPS: "+e.LagScale.get_fps())}function p(e){var t=L.getActorById(e[1]);if(t){t.position.set(e[2],e[3],e[4])}}function h(t){if(I){var i=Date.now();he=i-I.model.au_receive_metric.last_time;I.model.au_receive_metric.last_time=i}t.actors.forEach(function t(i){var r=L.getActorById(i.id);if(r){r.position.copy(i.position);r.scale=i.scale;if(r.type===e.ActorTypes.PLAYER_SPHERE){r.drain_target_id=i.drain_target_id;var n=e.Game.players[r.playerId];if(n){n.setSpeedBoostActive(i.speed_boosting)}}}})}function d(e){if(!T)return;var t=e.targetPlayerId;console.log("YOU CAPTURED PLAYER! ",t);te(t)}function f(e){if(!T)return;re(e)}function m(e){var t=e.attackingPlayerId;var i=e.targetPlayerId;if(!I||t!==I.getPlayerId()){ie(i)}}function _(e){if(!T)return;ee(e.tick_data)}function E(e){console.log("Server said: ",e.reason);oe();ne(e.reason)}function y(e){console.log("received remove_player",e.playerId);J(e.playerId,0)}function g(){if(!T)return;console.log("WARNING! You are speeding!")}function A(e){console.log("speed boost is valid:",e.is_valid);I.speedBoostStart()}function S(){console.log("Received speed boost STOP");I.speedBoostStop();Oe()}}function ve(){setTimeout(location.reload.bind(location),500)}function ye(){T=false;ce.send(JSON.stringify({op:"respawn"}))}function ge(){ue=Date.now();var t=Math.round(e.LagScale.get_fps());I.model.fps_metric.add(t);ce.send(JSON.stringify({op:"zor_ping",lastPing:pe,fps:t}))}function Ae(){fe=window.setInterval(ge,r.HEARTBEAT_PULSE_INTERVAL)}function Se(){var t=Date.now();var i=t-I.model.pp_send_metric.last_time;I.model.pp_send_metric.last_time=t;var r=ce.bufferedAmount;I.refreshSphereModel();var n=I.model.sphere;while(n.recentPositions.length<4){I.addRecentPosition()}var o={0:e.Schemas.ops.PLAYER_UPDATE,player_id:I.getPlayerId(),sphere_id:n.id,pp_gap:i,au_gap:he,buffered_mount:r,latest_position:n.recentPositions[n.recentPositions.length-1],prev_position_1:n.recentPositions[n.recentPositions.length-2],prev_position_2:n.recentPositions[n.recentPositions.length-3],prev_position_3:n.recentPositions[n.recentPositions.length-4],oldest_position:n.recentPositions[0],food_capture_queue:I.food_capture_queue};var a=e.Schemas.playerUdateSchema.encode(o);I.food_capture_queue=[];ce.send(a)}var we=new ArrayBuffer(20);var Ie=new Float32Array(we);function Re(t,i){if(!r.ENABLE_RAPID_UPDATES)return;Ie[0]=e.Schemas.ops.CLIENT_POSITION_RAPID;Ie[1]=t;Ie[2]=i.x;Ie[3]=i.y;Ie[4]=i.z;ce.send(we)}function Te(){ce.send(JSON.stringify({op:"speed_boost_start"}))}function Oe(){ce.send(JSON.stringify({op:"speed_boost_stop"}))}var Pe=i.throttle(Se,r.TICK_FAST_INTERVAL);function Le(){window.clearInterval(fe)}});
